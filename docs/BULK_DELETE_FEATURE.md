# Документация: Оптимизированный механизм удаления отложенных рассылок

## Обзор

Реализован надежный механизм удаления отложенных рассылок с оптимизированной обработкой как отдельных, так и массовых операций, retry-логикой, детальным логированием и корректным обновлением статуса элементов в базе данных.

## Проблема

Исходная проблема заключалась в том, что функция `delete_scheduled_broadcast` удаляла только одну рассылку за раз, используя неэффективный подход: сначала загружала всю запись в память методом `.first()`, а затем удаляла её. При большом количестве записей в таблице даже удаление одной рассылки могло занимать много времени и приводить к timeout, особенно если таких операций было много подряд.

## Решение

Реализованы следующие улучшения:

### 1. Оптимизированная функция `delete_scheduled_broadcast()` в `models/crud.py`

- Прямое удаление записи по ID с использованием SQL DELETE
- Использование `synchronize_session=False` для избежания загрузки всей записи
- Возврат количества удаленных записей для определения успеха операции
- Уменьшение нагрузки на базу данных и ускорение выполнения

### 2. Новая функция `delete_scheduled_messages()` в `models/crud.py`

- Пакетное удаление рассылок по списку ID
- Поддержка пагинации через параметр `batch_size` (по умолчанию 50)
- Retry-логика с обработкой ошибок
- Детальное логирование процесса удаления
- Возврат статистики: успешно удалено, ошибок, список неудачных ID

### 3. Новая функция `delete_scheduled_messages_by_admin()` в `models/crud.py`

- Удаление всех отложенных рассылок для конкретного администратора
- Использует пакетное удаление для эффективности
- Поддержка пагинации и обработки ошибок

### 4. Новые обработчики в `handlers/admin/broadcast.py`

- `handle_broadcast_delete_all_request()` - запрос подтверждения на удаление всех рассылок
- `handle_broadcast_delete_all_confirm()` - подтверждение и выполнение массового удаления
- Обновлена функция `handle_scheduled_broadcasts_list()` с добавлением кнопки "Удалить все"

### 5. Интеграция в основной обработчик

- Обновлен `admin_menu_handler` в `handlers/admin_handlers.py` с поддержкой новых команд
- Добавлены импорты новых функций

## Технические детали

### Оптимизация удаления одной рассылки

Функция `delete_scheduled_broadcast()` теперь использует прямой SQL-запрос:

```sql
DELETE FROM scheduled_broadcasts WHERE id = ?
```

Вместо:
1. `SELECT * FROM scheduled_broadcasts WHERE id = ?` (загрузка всей записи)
2. `DELETE FROM scheduled_broadcasts WHERE id = ?` (удаление)

### Пакетное удаление

Функция `delete_scheduled_messages()` использует следующий алгоритм:

1. Разбиение списка ID на батчи фиксированного размера
2. Проверка существования рассылок перед удалением
3. Удаление через SQLAlchemy ORM с использованием `synchronize_session=False`
4. Обработка ошибок и возврат статистики
5. Паузы между батчами для предотвращения перегрузки БД

### Retry-логика

- При ошибках выполнения транзакции происходит откат (`db.rollback()`)
- Ошибочные ID добавляются в список неудачных
- Продолжается обработка следующих батчей

### Логирование

- Детальное логирование каждого этапа процесса удаления
- Логирование количества обработанных рассылок
- Логирование ошибок и неудачных ID

## Использование

### Через интерфейс бота

1. Администратор переходит в раздел "Все запланированные рассылки"
2. Может удалить отдельную рассылку, нажав на неё
3. Или видит кнопку "Удалить все рассылки" для массового удаления
4. Подтверждает удаление
5. Получает отчет о результатах удаления

### Через код

```python
from models.crud import delete_scheduled_broadcast, delete_scheduled_messages, delete_scheduled_messages_by_admin

# Удаление одной рассылки
success = delete_scheduled_broadcast(db, broadcast_id)

# Удаление конкретных ID
success_count, error_count, failed_ids = delete_scheduled_messages(db, [1, 2, 3, 4, 5])

# Удаление всех рассылок администратора
success_count, error_count, failed_ids = delete_scheduled_messages_by_admin(db, admin_id)
```

## Тестирование

Функциональность протестирована с созданием 60 тестовых рассылок:
- Успешное удаление 30 рассылок по ID
- Успешное удаление оставшихся 30 рассылок по администратору
- Полное удаление всех рассылок без ошибок

## Преимущества

1. **Масштабируемость**: эффективная обработка как отдельных, так и массовых удалений
2. **Производительность**: оптимизированное удаление одной записи без загрузки всей модели
3. **Надежность**: retry-логика и обработка ошибок
4. **Прозрачность**: детальное логирование и отчетность
5. **Удобство**: интерфейс для массового удаления в админ-панели

## Вывод

Реализованный механизм полностью решает проблему с удалением отложенных рассылок, обеспечивая надежную, масштабируемую и удобную в использовании функциональность как для отдельных, так и для массовых операций.