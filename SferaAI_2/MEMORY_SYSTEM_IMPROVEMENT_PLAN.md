# –ü–ª–∞–Ω –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã –ø–∞–º—è—Ç–∏ Sfera AI

## 1. –¢–µ–∫—É—â–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —É–∑–∫–∏–µ –º–µ—Å—Ç–∞ (Bottlenecks)

–ù–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–¥–∞ (`agent.py`, `qdrant_memory_client.py`, `user_profile_manager.py`) –≤—ã—è–≤–ª–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –ø—Ä–æ–±–ª–µ–º—ã, –∑–∞–º–µ–¥–ª—è—é—â–∏–µ —Å—Ç–∞—Ä—Ç –∏ —Ä–∞–±–æ—Ç—É –∞–≥–µ–Ω—Ç–∞:

### üî¥ 1. –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≤–≤–æ–¥-–≤—ã–≤–æ–¥ (Blocking I/O)
–í —Ñ–∞–π–ª–µ `user_profile_manager.py` –º–µ—Ç–æ–¥—ã `load_profile` –∏ `save_profile` –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–±—ã—á–Ω—ã–π `open()`, –∫–æ—Ç–æ—Ä—ã–π –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.
*   **–í–ª–∏—è–Ω–∏–µ:** –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∞–≥–µ–Ω—Ç "–∑–∞–º–∏—Ä–∞–µ—Ç", –ø–æ–∫–∞ —á–∏—Ç–∞–µ—Ç—Å—è —Ñ–∞–π–ª –ø—Ä–æ—Ñ–∏–ª—è. –ï—Å–ª–∏ –¥–∏—Å–∫ –º–µ–¥–ª–µ–Ω–Ω—ã–π –∏–ª–∏ —Ñ–∞–π–ª –±–æ–ª—å—à–æ–π, —ç—Ç–æ –∑–∞–º–µ—Ç–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞.

### üî¥ 2. –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ (Sequential Loading)
–í `agent.py` –∑–∞–≥—Ä—É–∑–∫–∞ –ø–∞–º—è—Ç–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å—Ç—Ä–æ–≥–æ –ø–æ –æ—á–µ—Ä–µ–¥–∏:
1.  `user_profile_manager.get_formatted_profile` (–°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
2.  `await summary_manager.get_last_summary` (–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
3.  `await memory_client.get_all` (–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
*   **–í–ª–∏—è–Ω–∏–µ:** –í—Ä–µ–º—è —Å—Ç–∞—Ä—Ç–∞ = T(Profile) + T(Summary) + T(History). –≠—Ç–æ –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ.

### üî¥ 3. –ò–∑–±—ã—Ç–æ—á–Ω–∞—è –≤—ã–±–æ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö (Over-fetching)
–í `qdrant_memory_client.py` –º–µ—Ç–æ–¥ `get_all` –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç `limit=1000` –∑–∞–ø–∏—Å–µ–π.
–í `agent.py` –∏–∑ –Ω–∏—Ö –±–µ—Ä—É—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30: `results[:30]`.
*   **–í–ª–∏—è–Ω–∏–µ:** –ú—ã —Å–∫–∞—á–∏–≤–∞–µ–º –∏–∑ –±–∞–∑—ã, –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑—É–µ–º –∏ –ø–µ—Ä–µ–¥–∞–µ–º –ø–æ —Å–µ—Ç–∏ 970 –ª–∏—à–Ω–∏—Ö –∑–∞–ø–∏—Å–µ–π –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Å—Ç–∞—Ä—Ç–µ. –≠—Ç–æ —Ç—Ä–∞—Ç–∞ —Ç—Ä–∞—Ñ–∏–∫–∞ –∏ CPU.

### üî¥ 4. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
`UserProfileManager` —á–∏—Ç–∞–µ—Ç —Ñ–∞–π–ª —Å –¥–∏—Å–∫–∞ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ –∫–∞–∂–¥–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è –∏–ª–∏ —Å—Ç–∞—Ä—Ç–µ).
*   **–í–ª–∏—è–Ω–∏–µ:** –õ–∏—à–Ω—è—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –¥–∏—Å–∫.

---

## 2. –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (Architecture Improvements)

### üöÄ –≠—Ç–∞–ø 1: –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è (Quick Wins)

1.  **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ (Asyncio Gather):**
    –ó–∞–ø—É—Å–∫–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É –°–∞–º–º–∞—Ä–∏ –∏ –ò—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ. –≠—Ç–æ —Å–æ–∫—Ä–∞—Ç–∏—Ç –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç Qdrant –≤ 2 —Ä–∞–∑–∞.

2.  **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞ –∫ Qdrant:**
    –ò–∑–º–µ–Ω–∏—Ç—å –º–µ—Ç–æ–¥ `get_all` (–∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π `get_recent`), –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä `limit` –∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —É –±–∞–∑—ã —Ä–æ–≤–Ω–æ —Å—Ç–æ–ª—å–∫–æ, —Å–∫–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ (30 —à—Ç—É–∫), —Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –±–∞–∑—ã.

3.  **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π UserProfileManager:**
    –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å `UserProfileManager` –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `aiofiles` –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–∞–º–∏, —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å Event Loop.

### üß† –≠—Ç–∞–ø 2: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (Deep Dive)

4.  **In-Memory Caching –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è:**
    –•—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏ (–≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –∫–ª–∞—Å—Å–∞) –∏ –æ–±–Ω–æ–≤–ª—è—Ç—å —Ñ–∞–π–ª –Ω–∞ –¥–∏—Å–∫–µ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö. –ß—Ç–µ–Ω–∏–µ –±—É–¥–µ—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–º.

5.  **–£–º–Ω–æ–µ —Å–∂–∞—Ç–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (Smart Context):**
    –í–º–µ—Å—Ç–æ "—Ç—É–ø—ã—Ö" 30 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥:
    *   10 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–¥–ª—è –Ω–∏—Ç–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞).
    *   + –ü–æ–∏—Å–∫ 3-5 *—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö* –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–π –∏–∑ –ø—Ä–æ—à–ª–æ–≥–æ, –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –∫ —Ç–µ–∫—É—â–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏ (Semantic Search –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ, –µ—Å–ª–∏ –µ—Å—Ç—å –≤—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ).

6.  **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤:**
    –ú–æ–¥–µ–ª—å `fastembed` –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Å–æ–∑–¥–∞–Ω–∏–∏ `QdrantMemoryClient`? –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ–Ω–∞ —Å–∏–Ω–≥–ª—Ç–æ–Ω–æ–º. –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî —Å–¥–µ–ª–∞—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–º –æ–±—ä–µ–∫—Ç–æ–º, —á—Ç–æ–±—ã –Ω–µ –≥—Ä—É–∑–∏—Ç—å –≤–µ—Å–∞ –º–æ–¥–µ–ª–∏ –≤ –ø–∞–º—è—Ç—å –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ.

---

## 3. –ü–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –®–∞–≥ 1: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è `qdrant_memory_client.py`
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∞—Ä–≥—É–º–µ–Ω—Ç `limit` –≤ –º–µ—Ç–æ–¥ `get_all`.
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É `order_by` –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ Qdrant, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∞—Ç—å —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –∑–∞–ø–∏—Å–µ–π, –∞ –Ω–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ Python.

### –®–∞–≥ 2: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è `user_profile_manager.py`
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ: –∑–∞–≥—Ä—É–∂–∞—Ç—å JSON –≤ `self._cache` –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏.
- [ ] –°–¥–µ–ª–∞—Ç—å –º–µ—Ç–æ–¥—ã `get_formatted_profile` —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º–∏, –Ω–æ —á–∏—Ç–∞—é—â–∏–º–∏ –∏–∑ –∫—ç—à–∞ (–º–≥–Ω–æ–≤–µ–Ω–Ω–æ).
- [ ] –°–¥–µ–ª–∞—Ç—å –º–µ—Ç–æ–¥ `save_profile` –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º (–∏—Å–ø–æ–ª—å–∑—É—è `aiofiles` –∏–ª–∏ `run_in_executor`), —á—Ç–æ–±—ã –∑–∞–ø–∏—Å—å –Ω–∞ –¥–∏—Å–∫ –Ω–µ —Ç–æ—Ä–º–æ–∑–∏–ª–∞ –æ—Ç–≤–µ—Ç –∞–≥–µ–Ω—Ç–∞.

### –®–∞–≥ 3: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è `agent.py` (Entrypoint)
- [ ] –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å –±–ª–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞–º—è—Ç–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `asyncio.gather`:
    ```python
    # –ë—ã–ª–æ
    # profile = get_profile()
    # summary = await get_summary()
    # history = await get_history()

    # –°—Ç–∞–Ω–µ—Ç
    # profile = get_profile_from_cache() # –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ
    # summary_task = asyncio.create_task(summary_manager.get_last_summary(user_id))
    # history_task = asyncio.create_task(memory_client.get_recent_messages(user_id, limit=30))
    # summary, history = await asyncio.gather(summary_task, history_task)
    ```

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ `fastembed`
- [ ] –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –º–æ–¥–µ–ª—å —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –Ω–∞ —É—Ä–æ–≤–Ω–µ –º–æ–¥—É–ª—è, –∞ –Ω–µ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ.

---

## 4. –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
*   **–°–∫–æ—Ä–æ—Å—Ç—å —Å—Ç–∞—Ä—Ç–∞:** –£—Å–∫–æ—Ä–µ–Ω–∏–µ –Ω–∞ 40-60% –∑–∞ —Å—á–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞ –∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –ª–∏—à–Ω–∏—Ö –¥–∞–Ω–Ω—ã—Ö.
*   **–û—Ç–∑—ã–≤—á–∏–≤–æ—Å—Ç—å:** –ò—Å—á–µ–∑–Ω—É—Ç –º–∏–∫—Ä–æ-—Ñ—Ä–∏–∑—ã –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –ø—Ä–æ—Ñ–∏–ª–µ–º.
*   **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:** –ú–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–µ—Ç—å –∏ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.
