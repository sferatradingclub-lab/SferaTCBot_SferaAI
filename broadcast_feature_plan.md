# План реализации функции отложенной рассылки

## 1. Архитектурные изменения

### 1.1. Новая модель данных
Для хранения отложенных рассылок потребуется создать новую модель `ScheduledBroadcast`:

```python
from sqlalchemy import Column, Integer, String, DateTime, Text, Boolean
from sqlalchemy.sql import func
from .base import Base

class ScheduledBroadcast(Base):
    __tablename__ = "scheduled_broadcasts"
    
    id = Column(Integer, primary_key=True, index=True)
    message_content = Column(Text, nullable=False)  # JSON-строка с содержимым сообщения
    scheduled_datetime = Column(DateTime, nullable=False)
    created_at = Column(DateTime, default=func.now())
    is_sent = Column(Boolean, default=False)
    sent_at = Column(DateTime, nullable=True)
    admin_id = Column(Integer, nullable=False)  # ID администратора, создавшего рассылку
```

### 1.2. Изменения в состоянии администратора
Добавить новые состояния в `AdminState`:

```python
class AdminState(Enum):
    # ... существующие состояния ...
    BROADCAST_AWAITING_MESSAGE = auto()
    BROADCAST_AWAITING_CONFIRMATION = auto()
    BROADCAST_SCHEDULE_AWAITING_DATE = auto()  # Ожидание выбора даты
    BROADCAST_SCHEDULE_AWAITING_TIME = auto()  # Ожидание ввода времени
    BROADCAST_SCHEDULE_CONFIRMATION = auto()   # Подтверждение даты/времени
    BROADCAST_MANAGE_SCHEDULED = auto()        # Управление запланированными рассылками
    USERS_AWAITING_ID = auto()
    USERS_AWAITING_DM = auto()
```

### 1.3. Новые callback_data команды
- `broadcast_schedule_now` - отправить сейчас
- `broadcast_schedule_later` - отложенная отправка
- `broadcast_schedule_calendar` - развернуть календарь
- `broadcast_schedule_today` - сегодня
- `broadcast_schedule_tomorrow` - завтра
- `broadcast_schedule_day_after_tomorrow` - послезавтра
- `broadcast_schedule_change_date` - изменить дату
- `broadcast_schedule_all_scheduled` - все запланированные
- `broadcast_schedule_new` - новая рассылка
- `broadcast_schedule_view_` - просмотр конкретной рассылки

## 2. Реализация компонентов

### 2.1. Календарь
Реализовать инлайн-клавиатуру календаря с возможностью выбора даты. Календарь должен включать:
- Навигацию по месяцам
- Выбор даты
- Отображение текущей даты

Реализация календаря будет включать:
- Функцию генерации инлайн-клавиатуры календаря с навигацией по месяцам
- Обработчики callback-запросов для навигации и выбора даты
- Формат callback_data: `calendar_prev_month_YYYY-MM`, `calendar_next_month_YYYY-MM`, `calendar_select_YYYY-MM-DD`

### 2.2. Обработчики состояний
Создать новые обработчики для:
- Выбора даты и времени
- Подтверждения параметров рассылки
- Управления запланированными рассылками

### 2.3. Планировщик задач
Использовать существующий `job_queue` для планирования отправки рассылок в заданное время.

## 3. Логика работы

### 3.1. Сценарий отложенной рассылки
1. Администратор отправляет сообщение для рассылки
2. Бот показывает предварительный просмотр сообщения
3. Вместо двух кнопок ("отправить всем", "отмена") появляется три:
   - "Да, отправить сейчас"
   - "Отложенная отправка"
   - "Отмена"
4. При выборе "Отложенная отправка":
   - Бот показывает кнопки: "Развернуть календарь", "Сегодня", "Завтра", "Послезавтра"
   - При нажатии на "Развернуть календарь" - отображается календарь
   - При выборе даты - бот запрашивает время в формате "часы:минуты"
   - При вводе времени - бот подтверждает дату и время отправки
   - После подтверждения - рассылка планируется в базе данных
   - В заданное время - рассылка отправляется

### 3.2. Управление запланированными рассылками
- Отображение списка запланированных рассылок
- Возможность редактирования даты/времени
- Возможность отмены рассылки
- Возможность редактирования содержимого рассылки

## 4. Технические детали

### 4.1. Хранение содержимого сообщения
Содержимое сообщения (включая текст, изображения, медиа) будет сериализовано в JSON и сохранено в поле `message_content`. Это позволит воссоздать оригинальное сообщение при отправке.

### 4.2. Обработка медиа-контента
При планировании рассылки нужно сохранить file_id для всех медиа-файлов, чтобы иметь возможность отправить их позже.

### 4.3. Обработка ошибок
- Проверка корректности ввода времени
- Обработка попыток запланировать рассылку в прошлое
- Обработка ошибок при отправке запланированных рассылок

## 5. Требования к безопасности
- Проверка прав администратора при доступе к функциям рассылки
- Защита от спама - ограничение количества запланированных рассылок
- Логирование всех действий по рассылке

## 6. Тестирование
- Модульные тесты для новых функций
- Интеграционные тесты для сценариев планирования
- Тестирование обработки различных типов сообщений

## 7. Архитектурные компоненты

### 7.1. Модуль `models.broadcast`
Содержит модель `ScheduledBroadcast` и CRUD-операции для работы с отложенными рассылками

### 7.2. Модуль `handlers.calendar`
Содержит функции для генерации и обработки календаря

### 7.3. Модуль `handlers.admin.broadcast_extended`
Содержит расширенную логику обработки рассылок с поддержкой отложенной отправки

### 7.4. Модуль `services.broadcast_scheduler`
Служба для планирования и отправки отложенных рассылок

### 7.5. Модуль `keyboards.broadcast`
Содержит инлайн-клавиатуры для работы с рассылками