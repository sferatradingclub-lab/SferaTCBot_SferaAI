<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Путь Трейдера: Урок 3 - Механика Рынка</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        body { font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", sans-serif; overflow-y: auto; touch-action: manipulation; }
        .hide { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes screenShake { 0%, 100% { transform: translateX(0); } 20% { transform: translateX(-5px); } 40% { transform: translateX(5px); } 60% { transform: translateX(-5px); } 80% { transform: translateX(5px); } }
        .fade-in { animation: fadeIn 0.5s ease-in-out forwards; }
        .fade-in-up { animation: fadeInUp 0.5s ease-in-out forwards; }
        .pulse-btn { animation: pulse 2s infinite ease-in-out; }
        .screen-shake { animation: screenShake 0.3s linear; }
        .answer-btn { transition: all 0.2s ease-out; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1); }
        .answer-btn:hover { transform: translateY(-4px) scale(1.02); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.1); }
        .answer-btn:disabled { cursor: not-allowed; opacity: 0.7; }
        .btn-correct { background-color: #22c55e !important; border-color: #16a34a !important; color: white; transform: scale(1.05); }
        .btn-wrong { background-color: #ef4444 !important; border-color: #dc2626 !important; color: white; opacity: 0.6; }
        #game-container { transition: background 1s ease-in-out; }
        .level-1-bg { background: radial-gradient(circle, rgba(23,37,84,1) 0%, rgba(12,20,45,1) 100%); }
        .level-2-bg { background: radial-gradient(circle, rgba(55,48,163,1) 0%, rgba(20,15,60,1) 100%); }
        .level-3-bg { background: radial-gradient(circle, rgba(20,83,45,1) 0%, rgba(10,40,20,1) 100%); }
        .level-4-bg { background: radial-gradient(circle, rgba(120,29,29,1) 0%, rgba(50,10,10,1) 100%); }
        .level-5-bg { background: radial-gradient(circle, rgba(150,150,170,1) 0%, rgba(40,40,50,1) 100%); }
    .dev-badge{position:fixed;top:.5rem;left:.5rem;z-index:60;background:#0ea5e9;color:#fff;font-weight:700;font-size:.75rem;padding:.25rem .5rem;border-radius:.375rem;box-shadow:0 2px 8px rgba(0,0,0,.2);display:none}
.dev-panel{position:fixed;bottom:0;left:0;right:0;z-index:60;background:rgba(17,24,39,.98);border-top:1px solid rgba(255,255,255,.08);backdrop-filter:saturate(140%) blur(6px);padding:.75rem 1rem;display:none}
.dev-panel *{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
.dev-panel h3{font-size:.9rem;margin:0 0 .5rem 0;color:#93c5fd}
.dev-row{display:flex;gap:.5rem;align-items:center;margin-bottom:.5rem}
.dev-log{max-height:30vh;overflow:auto;font-size:.75rem;line-height:1.2;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:.5rem;padding:.5rem;color:#d1d5db}
.dev-btn{font-size:.75rem;padding:.35rem .6rem;border-radius:.375rem;border:1px solid rgba(255,255,255,.12);background:#111827;color:#e5e7eb}
.dev-btn:hover{background:#0b1220}
</style>
</head>
<body class="bg-gray-900 text-white">

    <div id="game-container" class="w-full min-h-screen flex flex-col items-center justify-center p-4 transition-all duration-500 level-1-bg">

        <div id="start-screen" class="text-center fade-in">
            <h1 class="text-5xl md:text-7xl font-black mb-2 text-transparent bg-clip-text bg-gradient-to-r from-sky-400 to-indigo-500">Путь Трейдера</h1>
            <p class="text-2xl font-bold mb-6 text-indigo-200">Урок 3: Механика Рынка</p>
            <p class="text-gray-300 mb-10 max-w-lg mx-auto">Вы торгуете не картинки, а заявки. Проверьте, научились ли вы "видеть деньги" в стакане и ленте.</p>
            <button id="start-btn" class="bg-gradient-to-r from-sky-500 to-indigo-600 hover:from-sky-600 hover:to-indigo-700 text-white font-bold py-4 px-10 rounded-xl text-xl shadow-lg shadow-indigo-500/30 pulse-btn">Начать проверку</button>
        </div>

        <div id="main-game" class="w-full max-w-4xl mx-auto h-full flex flex-col hide">
            <div class="w-full bg-gray-700/50 rounded-full h-2.5 mb-4 border border-white/10">
                <div id="global-progress-bar" class="bg-sky-500 h-full rounded-full" style="width:0%;transition:width .5s ease-in-out;"></div>
            </div>

            <div id="stats-bar" class="flex flex-wrap justify-between items-center gap-4 bg-black/30 p-3 sm:p-4 rounded-xl mb-4 border border-white/10 fade-in-up">
                <div>
                    <span class="text-xs sm:text-sm text-gray-400">Уровень</span>
                    <p class="text-base sm:text-xl font-bold text-sky-400" id="level-display"></p>
                </div>
                <div>
                    <span class="text-xs sm:text-sm text-gray-400">Капитал</span>
                    <p class="text-base sm:text-xl font-bold text-green-400" id="capital-display"></p>
                </div>
                <div>
                    <span class="text-xs sm:text-sm text-gray-400">Риск</span>
                    <div class="w-20 sm:w-24 bg-gray-700 rounded-full h-2.5">
                        <div id="risk-bar" class="bg-red-600 h-2.5 rounded-full" style="width:0%"></div>
                    </div>
                </div>
            </div>

            <div id="chart-container" class="flex-grow bg-black/30 p-4 rounded-xl border border-white/10 mb-4 fade-in-up" style="animation-delay:.1s;min-height:250px;">
                <canvas id="equity-chart"></canvas>
            </div>

            <div class="bg-black/30 p-6 rounded-xl border border-white/10 fade-in-up" style="animation-delay:.2s;">
                <p id="scenario-text" class="text-center text-lg md:text-xl font-medium mb-6 min-h-[80px] flex items-center justify-center"></p>
                <div id="answer-buttons" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>
        </div>

        <div id="modal-overlay" class="hide fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
            <div id="level-up-modal" class="hide text-center bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-2xl border-2 border-sky-500 max-w-md mx-4 w-full">
                 <h2 class="text-3xl sm:text-4xl font-black text-sky-400 mb-4">УРОВЕНЬ ПРОЙДЕН!</h2>
                 <p id="level-up-text" class="text-gray-300 text-base sm:text-lg mb-6 sm:mb-8"></p>
                 <button id="next-level-btn" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-6 sm:px-8 rounded-lg text-base sm:text-lg w-full">Продолжить</button>
            </div>
            <div id="game-over-modal" class="hide text-center bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-2xl border-2 border-red-500 max-w-md mx-4 w-full">
                 <h2 class="text-3xl sm:text-4xl font-black text-red-500 mb-4">ЛИКВИДАЦИЯ</h2>
                 <p class="text-gray-300 text-base sm:text-lg mb-6 sm:mb-8">Ваш капитал исчерпан. Неумение читать стакан и ленту привело к закономерному итогу. Проанализируйте ошибки и попробуйте снова!</p>
                 <button id="restart-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 sm:px-8 rounded-lg text-base sm:text-lg w-full">Начать заново</button>
            </div>
             <div id="game-win-modal" class="hide text-center bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-2xl border-2 border-green-500 max-w-md mx-4 w-full">
                 <h2 class="text-3xl sm:text-4xl font-black text-green-400 mb-4">УРОК 3 УСВОЕН!</h2>
                 <p class="text-gray-300 text-base sm:text-lg mb-6 sm:mb-8">Вы безупречно освоили механику рынка! Теперь вы готовы перейти от теории к построению полноценной торговой системы. Вы на правильном пути!</p>
                 <button id="restart-win-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 sm:px-8 rounded-lg text-base sm:text-lg w-full">Пройти снова</button>
            </div>
        </div>

    </div>

    <script>
        const gameContainer = document.getElementById('game-container');
        const startScreen = document.getElementById('start-screen');
        const mainGame = document.getElementById('main-game');
        const startBtn = document.getElementById('start-btn');
        const answerButtonsContainer = document.getElementById('answer-buttons');
        const levelDisplay = document.getElementById('level-display');
        const capitalDisplay = document.getElementById('capital-display');
        const riskBar = document.getElementById('risk-bar');
        const globalProgressBar = document.getElementById('global-progress-bar');
        const scenarioText = document.getElementById('scenario-text');
        const modalOverlay = document.getElementById('modal-overlay');
        const levelUpModal = document.getElementById('level-up-modal');
        const levelUpText = document.getElementById('level-up-text');
        const nextLevelBtn = document.getElementById('next-level-btn');
        const gameOverModal = document.getElementById('game-over-modal');
        const restartBtn = document.getElementById('restart-btn');
        const gameWinModal = document.getElementById('game-win-modal');
        const restartWinBtn = document.getElementById('restart-win-btn');
        const chartContainer = document.getElementById('chart-container');

        const levels = [
            { name: "Язык Стакана (DOM)", startCapital: 10000, scenarios: 10, marginCall: 8000, class: 'level-1-bg', levelUpMsg: "Вы научились отличать лимитные ордера от рыночных. Теперь пора найти след крупного игрока." },
            { name: "Плотности и Лента", startCapital: 15000, scenarios: 10, marginCall: 11000, class: 'level-2-bg', levelUpMsg: "Вы умеете находить 'стенки денег' и читать намерения в ленте. Время применить это в базовом сетапе." },
            { name: "Сетап: Отскок", startCapital: 20000, scenarios: 10, marginCall: 15000, class: 'level-3-bg', levelUpMsg: "Торговля от плотности освоена. Но что делать, когда стенку начинают 'разъедать'?" },
            { name: "Сетап: Разъедание", startCapital: 30000, scenarios: 10, marginCall: 22000, class: 'level-4-bg', levelUpMsg: "Вы научились входить на импульсе пробоя. Осталось добавить главный фильтр - контекст." },
            { name: "Контекст и Практика", startCapital: 50000, scenarios: 10, marginCall: 35000, class: 'level-5-bg', levelUpMsg: "ПОБЕДА!" },
        ];
        
        const scenariosByLevel = {
            1: [
                 { text: 'Что на самом деле двигает цену на рынке?', choices: [ { text: 'Лимитные ордера, которые выставляют трейдеры.', correct: false, impact: -800 }, { text: 'Рыночные ордера, которые "съедают" лимитную ликвидность.', correct: true, impact: 500 }, { text: 'Новостной фон и аналитика.', correct: false, impact: -500 }, { text: 'Движения индикаторов.', correct: false, impact: -1000 } ] },
                 { text: 'Вы смотрите в стакан (DOM). Что он вам показывает?', choices: [ { text: 'Прошлые сделки, которые уже совершились.', correct: false, impact: -700 }, { text: 'Очереди лимитных ордеров на покупку и продажу по каждой цене.', correct: true, impact: 600 }, { text: 'Настроение толпы в социальных сетях.', correct: false, impact: -1200 }, { text: 'Будущее движение цены.', correct: false, impact: -1500 } ] },
                 { text: 'Что такое "спред" (spread)?', choices: [ { text: 'Комиссия брокера за сделку.', correct: false, impact: -400 }, { text: 'Зазор между лучшей ценой покупки (bid) и лучшей ценой продажи (ask).', correct: true, impact: 700 }, { text: 'Самая крупная заявка в стакане.', correct: false, impact: -600 }, { text: 'Разница между ценой входа и стоп-лоссом.', correct: false, impact: -800 } ] },
                 { text: 'Главный след крупного игрока в стакане — это...', choices: [ { text: 'Частое появление мелких заявок.', correct: false, impact: -900 }, { text: 'Большая лимитная заявка ("плотность" или "стенка").', correct: true, impact: 800 }, { text: 'Резкое движение цены.', correct: false, impact: -500 }, { text: 'Отсутствие заявок на каком-то уровне.', correct: false, impact: -1000 } ] },
                 { text: 'Если вы видите, что крупная плотность в стакане то появляется, то исчезает ("мигает"), что это, скорее всего, означает?', choices: [ { text: 'У игрока проблемы со связью.', correct: false, impact: -800 }, { text: 'Это фейковая заявка (спуфинг) для манипуляции.', correct: true, impact: 900 }, { text: 'Это самый надежный уровень для входа.', correct: false, impact: -1500 }, { text: 'Это сигнал к немедленной покупке.', correct: false, impact: -1200 } ] },
                 { text: 'Что происходит в момент совершения сделки?', choices: [ { text: 'Пересекаются два рыночных ордера.', correct: false, impact: -1000 }, { text: 'Пересекаются два лимитных ордера.', correct: false, impact: -800 }, { text: 'Рыночный ордер исполняется об встречный лимитный ордер.', correct: true, impact: 700 }, { text: 'Цена просто меняется сама по себе.', correct: false, impact: -500 } ] },
                 { text: 'Если вы видите, что стенку лимитов на покупку "едят", но она постоянно восстанавливается (идет "подпитка"), это признак...', choices: [ { text: 'Слабости покупателей.', correct: false, impact: -1000 }, { text: 'Реального интереса к покупке на этом уровне.', correct: true, impact: 1000 }, { text: 'Манипуляции и скорого падения цены.', correct: false, impact: -800 }, { text: 'Технического сбоя в стакане.', correct: false, impact: -500 } ] },
                 { text: 'Почему утверждение "Ты торгуешь не картинки, а заявки" является ключевым?', choices: [ { text: 'Потому что графики часто врут.', correct: false, impact: -800 }, { text: 'Потому что реальное движение цены определяется балансом спроса и предложения в стакане.', correct: true, impact: 1100 }, { text: 'Потому что технический анализ не работает.', correct: false, impact: -1200 }, { text: 'Это просто красивое выражение для мотивации.', correct: false, impact: -500 } ] },
                 { text: 'Чем толще очередь лимитных ордеров на уровне, тем...', choices: [ { text: 'Легче цене пройти этот уровень.', correct: false, impact: -1500 }, { text: 'Больше инерция уровня, сложнее его "съесть" рыночными ордерами.', correct: true, impact: 800 }, { text: 'Более вероятно, что это фейковый уровень.', correct: false, impact: -800 }, { text: 'Меньше спред на этом уровне.', correct: false, impact: -400 } ] },
                 { text: 'Последняя совершенная сделка формирует...', choices: [ { text: 'Направление будущего тренда.', correct: false, impact: -800 }, { text: 'Текущую рыночную цену, которую вы видите на графике.', correct: true, impact: 600 }, { text: 'Размер спреда.', correct: false, impact: -500 }, { text: 'Настроение толпы.', correct: false, impact: -1000 } ] }
            ],
            2: [
                 { text: 'Что показывает Лента сделок (Time & Sales)?', choices: [ { text: 'Лимитные заявки в очереди.', correct: false, impact: -1000 }, { text: 'Поток УЖЕ исполненных рыночных ордеров (принтов).', correct: true, impact: 800 }, { text: 'Прогнозы аналитиков.', correct: false, impact: -1200 }, { text: 'Историю изменения спреда.', correct: false, impact: -500 } ] },
                 { text: 'Какая минимальная сумма в долларах считается значимой плотностью, согласно уроку?', choices: [ { text: '$50,000', correct: false, impact: -800 }, { text: '$1,000,000', correct: false, impact: -500 }, { text: 'От ~$500,000', correct: true, impact: 900 }, { text: 'Любая сумма больше $100,000.', correct: false, impact: -1000 } ] },
                 { text: 'Цена подходит к плотности на продажу (ask). В ленте вы видите серию крупных агрессивных принтов на покупку. Что это означает?', choices: [ { text: 'Покупатели слабы, скоро будет отскок вниз.', correct: false, impact: -1200 }, { text: 'Агрессор-покупатель "разъедает" стенку, возможен пробой вверх.', correct: true, impact: 1000 }, { text: 'Ничего не означает, лента - это шум.', correct: false, impact: -1500 }, { text: 'Продавцы сейчас добавят ликвидности.', correct: false, impact: -800 } ] },
                 { text: 'Цена стоит у плотности, но лента "вялая", принты мелкие и редкие. Это сигнал к...', choices: [ { text: 'Скорому пробою уровня.', correct: false, impact: -1000 }, { text: 'Высокой вероятности отскока от плотности.', correct: true, impact: 800 }, { text: 'Неопределенности, нужно ждать новостей.', correct: false, impact: -500 }, { text: 'Техническому сбою.', correct: false, impact: -200 } ] },
                 { text: 'Что такое кластера (footprint)?', choices: [ { text: 'Другое название для стакана (DOM).', correct: false, impact: -800 }, { text: 'График, показывающий будущие уровни поддержки.', correct: false, impact: -1000 }, { text: 'Фактически, "стакан исполненных заявок", показывающий, где прошел реальный объем.', correct: true, impact: 1100 }, { text: 'Индикатор настроений в соцсетях.', correct: false, impact: -1500 } ] },
                 { text: 'Где, согласно уроку, находятся "места силы" для торговли от плотности?', choices: [ { text: 'На исторических минимумах и максимумах.', correct: false, impact: -500 }, { text: 'При первом отскоке от плотности и в момент ее разъедания.', correct: true, impact: 900 }, { text: 'В середине ценового диапазона.', correct: false, impact: -800 }, { text: 'Там, где советуют аналитики.', correct: false, impact: -1200 } ] },
                 { text: 'Вы видите в ленте дисбаланс: у стенки на покупку (bid) сыпятся постоянные рыночные продажи. Что вы ждете?', choices: [ { text: 'Отскока вверх, так как покупатель сильный.', correct: false, impact: -1000 }, { text: 'Пробоя вниз, так как агрессия продавцов истощает лимитного покупателя.', correct: true, impact: 1200 }, { text: 'Рынок закроется на этой цене.', correct: false, impact: -500 }, { text: 'Резкого роста спреда.', correct: false, impact: -300 } ] },
                 { text: 'Зачем нужны кластера, если есть лента и стакан?', choices: [ { text: 'Они не нужны, это лишняя информация.', correct: false, impact: -800 }, { text: 'Они постфактум подтверждают, что объем действительно прошел по конкретной цене, подтверждая пробой/отскок.', correct: true, impact: 1000 }, { text: 'Они предсказывают, где появится следующая плотность.', correct: false, impact: -1200 }, { text: 'Они красивее, чем лента.', correct: false, impact: -500 } ] },
                 { text: 'Принцип "Контекст -> Наличие денег -> Намерение -> Исполнение" означает:', choices: [ { text: 'Новость -> Деньги на счету -> Желание -> Сделка.', correct: false, impact: -1000 }, { text: 'Уровень на графике -> Плотность в стакане -> Ускорение ленты -> Вход.', correct: true, impact: 1300 }, { text: 'Индикатор -> Сигнал -> Риск -> Тейк.', correct: false, impact: -800 }, { text: 'Это просто набор случайных слов.', correct: false, impact: -500 } ] },
                 { text: 'Разъедание плотности — это процесс, когда...', choices: [ { text: 'Крупный игрок убирает свою лимитную заявку.', correct: false, impact: -800 }, { text: 'Рыночные ордера постепенно исполняют все лимитные заявки в крупной стенке.', correct: true, impact: 900 }, { text: 'Спред резко расширяется.', correct: false, impact: -500 }, { text: 'Терминал начинает зависать.', correct: false, impact: -200 } ] }
            ],
            3: [
                 { text: 'Вы торгуете сетап "Отскок от плотности". Цена впервые подходит к стенке на $500к. Лента вялая. Как правильно войти в позицию?', choices: [ { text: 'Рыночным ордером, как только цена коснется стенки.', correct: false, impact: -1000 }, { text: 'Лимитным ордером прямо перед стенкой или за ней.', correct: true, impact: 800 }, { text: 'Ждать, пока стенку разъедят, и войти на пробой.', correct: false, impact: -800 }, { text: 'Не входить, это слишком рискованно.', correct: false, impact: -500 } ] },
                 { text: 'В сетапе "Отскок от плотности", где должен располагаться ваш стоп-лосс?', choices: [ { text: 'Далеко за уровнем, чтобы его не выбило.', correct: false, impact: -1200 }, { text: 'На несколько тиков за плотностью. Если ее съедают - мы не правы.', correct: true, impact: 1000 }, { text: 'Стоп-лосс не нужен, плотность защитит.', correct: false, impact: -2500 }, { text: 'В точке входа (безубыток).', correct: false, impact: -800 } ] },
                 { text: 'Какая основная логика заработка в сетапе "Отскок от плотности"?', choices: [ { text: 'Мы зарабатываем на панике толпы.', correct: false, impact: -800 }, { text: 'Мы используем крупную заявку как опору ("покупаем/продаем ликвидность").', correct: true, impact: 900 }, { text: 'Мы ловим случайное движение.', correct: false, impact: -1000 }, { text: 'Мы следуем за трендом.', correct: false, impact: -500 } ] },
                 { text: 'Какой фильтр является ОБЯЗАТЕЛЬНЫМ для сетапа "Отскок от плотности"?', choices: [ { text: 'Цена должна быть у исторического максимума.', correct: false, impact: -500 }, { text: 'Плотность должна быть реальной (не "мигать"), а лента у уровня - вялой.', correct: true, impact: 1100 }, { text: 'Индикатор RSI должен быть в зоне перепроданности.', correct: false, impact: -1000 }, { text: 'Должна выйти позитивная новость.', correct: false, impact: -800 } ] },
                 { text: 'Когда НЕ следует торговать сетап "Отскок от плотности"?', choices: [ { text: 'Когда плотность очень большая.', correct: false, impact: -500 }, { text: 'Когда в ленте идет серия агрессивных ударов по плотности.', correct: true, impact: 800 }, { text: 'Когда на рынке боковик.', correct: false, impact: -300 }, { text: 'Когда это первое касание уровня.', correct: false, impact: -1000 } ] },
                 { text: 'Где находится потенциал для тейк-профита в сетапе "Отскок"?', choices: [ { text: 'На случайном расстоянии от входа.', correct: false, impact: -800 }, { text: 'У следующей зоны ликвидности или значимого уровня на графике.', correct: true, impact: 900 }, { text: 'Нужно ждать удвоения депозита.', correct: false, impact: -1500 }, { text: 'Как только позиция вышла в небольшой плюс.', correct: false, impact: -400 } ] },
                 { text: 'Почему для отскока важен именно ПЕРВЫЙ подход цены к плотности?', choices: [ { text: 'Потому что это самое безопасное.', correct: false, impact: -500 }, { text: 'Потому что на последующих подходах часть ликвидности уже может быть исполнена, и стенка слабеет.', correct: true, impact: 1000 }, { text: 'Это не важно, можно входить на любом подходе.', correct: false, impact: -1200 }, { text: 'Потому что так написано в книгах.', correct: false, impact: -800 } ] },
                 { text: 'Вы вошли в отскок, но видите, что стенку не подпитывают, а наоборот, начинают агрессивно "есть". Ваши действия?', choices: [ { text: 'Увеличить позицию, усредниться.', correct: false, impact: -2000 }, { text: 'Ждать стоп-лосса.', correct: false, impact: -800 }, { text: 'Выйти из позиции раньше стопа, так как сценарий отменился.', correct: true, impact: 700 }, { text: 'Передвинуть стоп-лосс подальше.', correct: false, impact: -2500 } ] },
                 { text: 'Какой тип входа предпочтителен для отскока?', choices: [ { text: 'Рыночный.', correct: false, impact: -800 }, { text: 'Лимитный.', correct: true, impact: 600 }, { text: 'Stop-Market.', correct: false, impact: -500 }, { text: 'Не имеет значения.', correct: false, impact: -300 } ] },
                 { text: 'Что из перечисленного НЕ является фильтром для входа в отскок?', choices: [ { text: 'Актив "в игре" (высокий RVOL).', correct: false, impact: 100 }, { text: 'Пересечение двух скользящих средних.', correct: true, impact: -1000 }, { text: 'Реальная плотность от $500k.', correct: false, impact: 100 }, { text: 'Отсутствие агрессии в ленте.', correct: false, impact: 100 } ] }
            ],
            4: [
                 { text: 'В чем основной смысл сетапа "Разъедание стенки"?', choices: [ { text: 'Поймать отскок от уровня.', correct: false, impact: -1000 }, { text: 'Войти в сторону пробоя, который запускается на срабатывании стопов других участников.', correct: true, impact: 1200 }, { text: 'Торговать в боковике.', correct: false, impact: -800 }, { text: 'Найти самую большую плотность и встать против нее.', correct: false, impact: -1500 } ] },
                 { text: 'Какой главный триггер для входа в сетап "Разъедание стенки"?', choices: [ { text: 'Вялая лента и отсутствие принтов.', correct: false, impact: -1200 }, { text: 'Серия агрессивных принтов в ленте, "проедающих" плотность, и ее исчезновение.', correct: true, impact: 1100 }, { text: 'Сигнал от индикатора MACD.', correct: false, impact: -1000 }, { text: 'Цена просто коснулась уровня.', correct: false, impact: -800 } ] },
                 { text: 'Как правильно войти в позицию при разъедании стенки?', choices: [ { text: 'Лимитным ордером далеко до пробоя.', correct: false, impact: -800 }, { text: 'По рынку или лимитом в сторону движения сразу после "проглатывания" стенки.', correct: true, impact: 1000 }, { text: 'После того, как цена уже сильно улетела.', correct: false, impact: -1500 }, { text: 'Против движения, ожидая ложного пробоя.', correct: false, impact: -2000 } ] },
                 { text: 'Где должен находиться стоп-лосс в сетапе на пробой?', choices: [ { text: 'Далеко от точки входа.', correct: false, impact: -1000 }, { text: 'За пробитым уровнем или за остатком объема в кластерах (короткий стоп).', correct: true, impact: 900 }, { text: 'Стоп не нужен, движение будет сильным.', correct: false, impact: -3000 }, { text: 'В точке безубытка.', correct: false, impact: -500 } ] },
                 { text: 'Основной источник вашей прибыли в сетапе "Разъедание стенки" — это...', choices: [ { text: 'Ваша удача.', correct: false, impact: -1000 }, { text: 'Массовое срабатывание стоп-ордеров тех, кто стоял против движения.', correct: true, impact: 1300 }, { text: 'Ликвидность крупного игрока.', correct: false, impact: -800 }, { text: 'Коррекция рынка.', correct: false, impact: -500 } ] },
                 { text: 'Что подтверждает в кластерах факт "съеденной" стенки?', choices: [ { text: 'Отсутствие объема на уровне.', correct: false, impact: -800 }, { text: 'Большое количество исполненных ордеров (объема) на этом ценовом уровне.', correct: true, impact: 1000 }, { text: 'Кластера не могут ничего подтвердить.', correct: false, impact: -1200 }, { text: 'Появление дисбаланса.', correct: false, impact: -500 } ] },
                 { text: 'Вы видите, что стенку разъедают, но вы не успели войти в самом начале. Ваши действия?', choices: [ { text: 'Войти по любой цене, "догоняя" движение.', correct: false, impact: -1800 }, { text: 'Пропустить вход, так как хороший риск/награда уже упущен.', correct: true, impact: 500 }, { text: 'Войти удвоенным объемом, чтобы компенсировать опоздание.', correct: false, impact: -2500 }, { text: 'Войти в противоположную сторону.', correct: false, impact: -1500 } ] },
                 { text: 'Чем отличается фильтр для "Отскока" от фильтра для "Разъедания"?', choices: [ { text: 'Ничем, они одинаковые.', correct: false, impact: -800 }, { text: 'Для отскока нужна "вялая" лента, для разъедания - "агрессивная" лента.', correct: true, impact: 1200 }, { text: 'Для разъедания нужна большая плотность, а для отскока - маленькая.', correct: false, impact: -1000 }, { text: 'Фильтры не нужны, главное - интуиция.', correct: false, impact: -1500 } ] },
                 { text: 'Где находится логичный тейк-профит для сделки на пробой?', choices: [ { text: 'На ближайшем круглом числе.', correct: false, impact: -500 }, { text: 'У следующей зоны ликвидности / там, где, предположительно, стоят стопы толпы.', correct: true, impact: 1000 }, { text: 'Сразу после небольшого импульса.', correct: false, impact: -800 }, { text: 'Тейк-профит не нужен, нужно держать до конца дня.', correct: false, impact: -1200 } ] },
                 { text: 'Уровень уже много раз тестировался. На очередном подходе к нему вы видите агрессию в ленте. Какой сетап более вероятен?', choices: [ { text: 'Отскок от плотности.', correct: false, impact: -1000 }, { text: 'Разъедание стенки и пробой.', correct: true, impact: 800 }, { text: 'Формирование боковика.', correct: false, impact: -300 }, { text: 'Нужно ждать новостей.', correct: false, impact: -500 } ] }
            ],
            5: [
                 { text: 'Что такое "Актив в игре"?', choices: [ { text: 'Любой актив, который сейчас торгуется на бирже.', correct: false, impact: -1000 }, { text: 'Актив, показывающий высокий относительный объем (RVOL) и направленное движение.', correct: true, impact: 1000 }, { text: 'Актив, о котором много пишут в новостях.', correct: false, impact: -800 }, { text: 'Самый дешевый актив на бирже.', correct: false, impact: -1200 } ] },
                 { text: 'Почему опасно торговать на низком относительном объеме (RVOL)?', choices: [ { text: 'Потому что комиссии выше.', correct: false, impact: -500 }, { text: 'Потому что любые точки входа превращаются в лотерею с низким матожиданием.', correct: true, impact: 1200 }, { text: 'Потому что терминал может зависнуть.', correct: false, impact: -300 }, { text: 'Это не опасно, а наоборот, безопасно.', correct: false, impact: -1500 } ] },
                 { text: 'Вы видите идеальную плотность, но в активе низкий RVOL и боковик. Ваши действия?', choices: [ { text: 'Торговать отскок, ведь плотность есть.', correct: false, impact: -1500 }, { text: 'Не торговать, а лишь разметить уровень и ждать, пока в активе начнется "игра".', correct: true, impact: 800 }, { text: 'Торговать пробой с уменьшенным риском.', correct: false, impact: -1000 }, { text: 'Увеличить риск, чтобы "раскачать" рынок.', correct: false, impact: -2500 } ] },
                 { text: 'Для чего нужен ежедневный "DOM-дрилл" (наблюдение за стаканом)?', choices: [ { text: 'Чтобы найти 100% выигрышный сетап.', correct: false, impact: -1000 }, { text: 'Чтобы "натренировать глаз" видеть реальные плотности и их влияние на цену.', correct: true, impact: 1100 }, { text: 'Это медитативная практика для успокоения.', correct: false, impact: -500 }, { text: 'Чтобы выучить все типы ордеров.', correct: false, impact: -800 } ] },
                 { text: 'Какой из активов, скорее всего, будет "в игре"?', choices: [ { text: 'Биткоин, стоящий в узком боковике 2 дня.', correct: false, impact: -800 }, { text: 'Монета с меньшей капитализацией, показывающая RVOL 5.0 и рост на 15% за час.', correct: true, impact: 900 }, { text: 'Любой стейблкоин.', correct: false, impact: -500 }, { text: 'Актив, у которого самый низкий объем торгов.', correct: false, impact: -1200 } ] },
                 { text: 'Вы комментируете ленту вслух во время записи экрана. Какова цель этого упражнения?', choices: [ { text: 'Создание ASMR-контента для трейдеров.', correct: false, impact: -500 }, { text: 'Чтобы сфокусироваться на потоке сделок и потом оценить, правильно ли вы читали намерения рынка.', correct: true, impact: 1000 }, { text: 'Чтобы не уснуть на тихом рынке.', correct: false, impact: -300 }, { text: 'Это бесполезно, лучше молча смотреть.', correct: false, impact: -800 } ] },
                 { text: 'Вы ведете "Таблицу плотностей". Какую информацию НЕ нужно в нее вносить?', choices: [ { text: 'Размер плотности в $.', correct: false, impact: 50 }, { text: 'Исход (отскок/пробой).', correct: false, impact: 50 }, { text: 'Прогноз погоды на завтра.', correct: true, impact: -200 }, { text: 'Была ли подпитка стенки.', correct: false, impact: 50 } ] },
                 { text: 'Нашли на графике уровень, где в кластерах "исполнено много". Что это за зона?', choices: [ { text: 'Зона, которую нужно избегать.', correct: false, impact: -800 }, { text: 'Будущая зона интереса, поддержки/сопротивления, или цель для тейк-профита.', correct: true, impact: 1100 }, { text: 'Место, где у брокера был сбой.', correct: false, impact: -500 }, { text: 'Ничего не значащая информация.', correct: false, impact: -1200 } ] },
                 { text: 'Итоговая мысль урока 3: "Ты учишься видеть деньги". Что это означает?', choices: [ { text: 'Что вы научитесь предсказывать будущее.', correct: false, impact: -1000 }, { text: 'Вы учитесь читать намерения участников через ликвидность (DOM), агрессию (лента) и объем (кластера).', correct: true, impact: 1300 }, { text: 'Что трейдинг - это легкие деньги.', correct: false, impact: -1500 }, { text: 'Это метафора богатства.', correct: false, impact: -500 } ] },
                 { text: 'Без понимания механики рынка (DOM, лента) скальпинг превращается в...', choices: [ { text: 'Управляемую систему рисков.', correct: false, impact: -800 }, { text: 'Гадание по графическим паттернам.', correct: true, impact: 800 }, { text: 'Высокоточную торговлю.', correct: false, impact: -1000 }, { text: 'Спокойный и размеренный процесс.', correct: false, impact: -500 } ] }
            ]
        };
        
        let gameState = {};
        let equityChart;
        let audioSynth;
        let isAudioEnabled = false;

        function initGame() {
    startScreen.classList.remove('hide');
    mainGame.classList.add('hide');
    modalOverlay.classList.add('hide');
    // сброс/инициализация трекинга
    gameState.correctCount = 0;
    gameState.wrongCount = 0;
    gameState.startedAt = Date.now();

    if (!audioSynth && typeof Tone !== 'undefined') {
        try {
            audioSynth = {
                correct: new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 } }).toDestination(),
                wrong: new Tone.Synth({ oscillator: { type: "square" }, envelope: { attack: 0.005, decay: 0.2, sustain: 0, release: 0.2 } }).toDestination(),
                click: new Tone.MembraneSynth({ pitchDecay: 0.008, octaves: 2, envelope: { attack: 0.001, decay: 0.2, sustain: 0 } }).toDestination(),
                levelUp: new Tone.PolySynth(Tone.Synth).toDestination()
            };
            isAudioEnabled = true;
        } catch (e) { console.error('Audio init error', e); isAudioEnabled = false; }
    } else if (typeof Tone === 'undefined') { isAudioEnabled = false; }
}

async function startGame() {
            if (isAudioEnabled && Tone.context.state !== 'running') {
                try { await Tone.start(); } catch(e) { console.error('Audio start error', e); isAudioEnabled = false; }
            }
            playSound('click');
            startScreen.classList.add('hide');
            mainGame.classList.remove('hide');
            loadLevel(0);
        }

        function loadLevel(levelIndex) {
            const levelData = levels[levelIndex];
            const scenarioPool = scenariosByLevel[levelIndex + 1];
            gameState = { level: levelIndex, capital: levelData.startCapital, marginCall: levelData.marginCall, scenarios: shuffleArray([...scenarioPool]).slice(0, levelData.scenarios), currentScenario: 0, equityData: [levelData.startCapital] };
            levelDisplay.textContent = `${levelIndex + 1}: ${levelData.name}`;
            updateCapitalDisplay();
            updateGlobalProgress();
            gameContainer.className = `w-full min-h-screen flex flex-col items-center justify-center p-4 transition-all duration-500 ${levelData.class}`;
            setupChart();
            displayScenario();
        }

        function displayScenario() {
            if (gameState.currentScenario >= gameState.scenarios.length) { levelUp(); return; }
            const scenario = gameState.scenarios[gameState.currentScenario];
            scenarioText.textContent = scenario.text;
            const shuffledChoices = shuffleArray([...scenario.choices]);
            answerButtonsContainer.innerHTML = '';
            shuffledChoices.forEach(choice => {
                const button = document.createElement('button');
                button.textContent = choice.text;
                button.className = 'answer-btn w-full text-left p-4 rounded-lg bg-gray-700/50 hover:bg-gray-600/50 border border-white/20 backdrop-blur-sm';
                button.onclick = () => selectAnswer(choice);
                answerButtonsContainer.appendChild(button);
            });
        }
        
        function selectAnswer(choice) {
    playSound('click');
    const buttons = answerButtonsContainer.querySelectorAll('button');
    buttons.forEach(btn => {
        btn.disabled = true;
        const btnChoice = gameState.scenarios[gameState.currentScenario].choices.find(c => c.text === btn.textContent);
        if (btnChoice && btnChoice.correct) btn.classList.add('btn-correct');
        else if (btn.textContent === choice.text) btn.classList.add('btn-wrong');
    });

    // учёт результата
    if (choice.correct) { gameState.correctCount = (gameState.correctCount || 0) + 1; }
    else { gameState.wrongCount = (gameState.wrongCount || 0) + 1; }

    gameState.capital += choice.impact;
    updateCapitalDisplay();

    if (choice.correct) playSound('correct');
    else { playSound('wrong'); gameContainer.classList.add('screen-shake'); setTimeout(() => gameContainer.classList.remove('screen-shake'), 300); }

    if (gameState.capital <= gameState.marginCall) { setTimeout(gameOver, 2000); return; }

    gameState.currentScenario++;
    updateGlobalProgress();
    setTimeout(displayScenario, 2000);
}

function levelUp() {
            const currentLevel = gameState.level;
            if (currentLevel + 1 >= levels.length) { gameWin(); return; }
            playSound('levelUp');
            modalOverlay.classList.remove('hide');
            levelUpModal.classList.remove('hide');
            levelUpText.textContent = levels[currentLevel].levelUpMsg;
            gameState.level++;
        }
        
        function proceedToNextLevel() {
            playSound('click');
            modalOverlay.classList.add('hide');
            levelUpModal.classList.add('hide');
            loadLevel(gameState.level);
        }

        function gameOver() {
    playSound('wrong');
    modalOverlay.classList.remove('hide');
    gameOverModal.classList.remove('hide');
    // Hook: провал урока (ликвидация)
    const detail = Object.assign({}, getGameStats(), { reason: 'marginCall' });
    emitHook('lessonFailed', detail);
}

function gameWin() {
    playSound('levelUp');
    modalOverlay.classList.remove('hide');
    gameWinModal.classList.remove('hide');
    globalProgressBar.style.width = '100%';
    // Hook: успешное завершение урока
    const detail = getGameStats();
    emitHook('lessonComplete', detail);
}

function restartGame() {
    playSound('click');
    initGame();
}

function updateCapitalDisplay() {
    capitalDisplay.textContent = `$${gameState.capital.toLocaleString()}`;
    gameState.equityData.push(gameState.capital);
    updateChart();
    const level = levels[gameState.level];
    const capitalRange = level.startCapital - level.marginCall;
    const capitalLost = level.startCapital - gameState.capital;
    const riskPercent = Math.max(0, Math.min(100, (capitalLost / capitalRange) * 100));
    riskBar.style.width = `${riskPercent}%`;
}

function updateGlobalProgress() {
    const totalScenarios = levels.length * levels[0].scenarios;
    const scenariosCompleted = gameState.level * levels[0].scenarios + gameState.currentScenario;
    const progress = (scenariosCompleted / totalScenarios) * 100;
    globalProgressBar.style.width = `${progress}%`;
}

function setupChart() {
    if (typeof Chart === 'undefined') {
        console.error('Chart.js not loaded.');
        chartContainer.innerHTML = `<div class="flex items-center justify-center h-full text-gray-400">График недоступен</div>`;
        return;
    }
    const canvas = document.getElementById('equity-chart');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    if (equityChart) equityChart.destroy();
    try {
        equityChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: gameState.equityData.map((_, i) => i === 0 ? 'Start' : `S${i}`),
                datasets: [{
                    label: 'Капитал',
                    data: gameState.equityData,
                    borderColor: '#38bdf8',
                    backgroundColor: 'rgba(56, 189, 248, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointBackgroundColor: '#38bdf8'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { ticks: { color: 'rgba(255,255,255,0.5)' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                    x: { ticks: { color: 'rgba(255,255,255,0.5)' }, grid: { display: false } }
                }
            }
        });
    } catch (e) {
        console.error('Chart creation error:', e);
        chartContainer.innerHTML = `<div class="flex items-center justify-center h-full text-gray-400">Ошибка при загрузке графика</div>`;
    }
}

function updateChart() {
    if (!equityChart) return;
    equityChart.data.labels = gameState.equityData.map((_, i) => i === 0 ? 'Start' : `S${i}`);
    equityChart.data.datasets[0].data = gameState.equityData;
    equityChart.update();
}

function playSound(type) {
    if (!isAudioEnabled || !audioSynth) return;
    try {
        const now = Tone.now();
        if (type === 'correct') audioSynth.correct.triggerAttackRelease('E5', '8n', now);
        else if (type === 'wrong') audioSynth.wrong.triggerAttackRelease('C3', '8n', now);
        else if (type === 'click') audioSynth.click.triggerAttackRelease('C2', '8n', now);
        else if (type === 'levelUp') audioSynth.levelUp.triggerAttackRelease(['C4','E4','G4','C5'], '8n', now);
    } catch (e) { console.error('Audio play error', e); }
}

function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

// Hook helpers
function getGameStats() {
    const totalLevels = levels.length;
    const totalPlannedScenarios = levels.reduce((sum, l) => sum + l.scenarios, 0);
    const answered = (gameState.level * levels[0].scenarios) + (gameState.currentScenario || 0);
    return {
        version: 'v1.1.0',
        startedAt: gameState.startedAt || null,
        finishedAt: Date.now(),
        totalLevels,
        currentLevel: (gameState.level || 0) + 1,
        capital: gameState.capital,
        marginCall: gameState.marginCall,
        correct: gameState.correctCount || 0,
        wrong: gameState.wrongCount || 0,
        answered,
        totalPlannedScenarios
    };
}
function emitHook(name, detail) {
    try { window.dispatchEvent(new CustomEvent(name, { detail })); } catch (e) { console.error('Hook dispatch error', e); }
    try { if (name === 'lessonComplete' && typeof window.onGameComplete === 'function') { window.onGameComplete(detail); } } catch (e) { console.error('onGameComplete error', e); }
}
// Экспорт минимального API
window.gameAPI = { getStats: getGameStats, restart: restartGame, version: 'v1.1.0' };

// ===== DEV PANEL (no-console testing) =====
let __DEV_ENABLED__ = false; const __DEV_BUF__ = [];
function __devLog(evt, data){ const time = new Date().toLocaleTimeString(); __DEV_BUF__.push({time,evt,data}); if(!__DEV_ENABLED__) return; const log = document.getElementById('dev-log'); if(!log) return; const row = document.createElement('div'); row.textContent = `[${time}] ${evt}: ` + JSON.stringify(data); log.appendChild(row); log.scrollTop = log.scrollHeight; }
function __ensureDevPanel(){ if(document.getElementById('dev-panel')) return; const badge = document.createElement('div'); badge.id='dev-badge'; badge.className='dev-badge'; badge.textContent='DEV'; document.body.appendChild(badge);
  const panel = document.createElement('div'); panel.id='dev-panel'; panel.className='dev-panel'; panel.innerHTML = `
    <h3>DEV / Hook Tester</h3>
    <div class="dev-row">
      <button class="dev-btn" id="dev-ok">Симулировать успех</button>
      <button class="dev-btn" id="dev-fail">Симулировать провал</button>
      <button class="dev-btn" id="dev-clear">Очистить лог</button>
    </div>
    <div id="dev-log" class="dev-log"></div>`;
  document.body.appendChild(panel);
  document.getElementById('dev-ok').onclick = ()=>emitHook('lessonComplete', Object.assign(getGameStats(), { test:true }));
  document.getElementById('dev-fail').onclick = ()=>emitHook('lessonFailed', Object.assign(getGameStats(), { reason:'manualTest', test:true }));
  document.getElementById('dev-clear').onclick = ()=>{ const log=document.getElementById('dev-log'); if(log) log.innerHTML=''; };
}
function __toggleDev(){ __ensureDevPanel(); __DEV_ENABLED__ = !__DEV_ENABLED__; const p = document.getElementById('dev-panel'); const b = document.getElementById('dev-badge'); if(!p||!b) return; p.style.display = __DEV_ENABLED__ ? 'block' : 'none'; b.style.display = __DEV_ENABLED__ ? 'inline-block' : 'none'; if(__DEV_ENABLED__){ const log=document.getElementById('dev-log'); if(log){ log.innerHTML=''; __DEV_BUF__.forEach(x=>{ const d=document.createElement('div'); d.textContent = `[${x.time}] ${x.evt}: `+JSON.stringify(x.data); log.appendChild(d); }); } } }
// Логирование хуков
window.addEventListener('lessonComplete', e=>__devLog('lessonComplete', e.detail));
window.addEventListener('lessonFailed',   e=>__devLog('lessonFailed', e.detail));
// Тогглы DEV: двойной клик по заголовку ИЛИ Shift+D
(function(){
  const tryBind = ()=>{ const title = document.querySelector('#start-screen h1'); if(!title) return false; title.addEventListener('dblclick', __toggleDev); return true; };
  if(!tryBind()) { const obs = new MutationObserver(()=>{ if(tryBind()) obs.disconnect(); }); obs.observe(document.body, { childList:true, subtree:true }); }
  document.addEventListener('keydown', (e)=>{ if(e.shiftKey && e.key && e.key.toLowerCase() === 'd') __toggleDev(); });
})();

// События UI
startBtn.addEventListener('click', startGame);
nextLevelBtn.addEventListener('click', proceedToNextLevel);
restartBtn.addEventListener('click', restartGame);
restartWinBtn.addEventListener('click', restartGame);
window.onload = initGame;
    </script>
</body>
</html>