<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Путь Трейдера: Урок 1 - Реальность</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow-y: auto; 
            touch-action: manipulation;
        }
        .hide { display: none !important; }

        /* --- Custom Animations --- */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes screenShake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-5px); }
            40% { transform: translateX(5px); }
            60% { transform: translateX(-5px); }
            80% { transform: translateX(5px); }
        }

        .fade-in { animation: fadeIn 0.5s ease-in-out forwards; }
        .fade-in-up { animation: fadeInUp 0.5s ease-in-out forwards; }
        .pulse-btn { animation: pulse 2s infinite ease-in-out; }
        .screen-shake { animation: screenShake 0.3s linear; }

        /* --- Button Styles --- */
        .answer-btn {
            transition: all 0.2s ease-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .answer-btn:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
        }
        .answer-btn:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }
        .btn-correct {
            background-color: #22c55e !important;
            border-color: #16a34a !important;
            color: white;
            transform: scale(1.05);
        }
        .btn-wrong {
            background-color: #ef4444 !important;
            border-color: #dc2626 !important;
            color: white;
            opacity: 0.6;
        }
        
        /* --- Backgrounds --- */
        #game-container { transition: background 1s ease-in-out; }
        .level-1-bg { background: radial-gradient(circle, rgba(23,37,84,1) 0%, rgba(12,20,45,1) 100%); }
        .level-2-bg { background: radial-gradient(circle, rgba(55, 48, 163,1) 0%, rgba(20, 15, 60,1) 100%); }
        .level-3-bg { background: radial-gradient(circle, rgba(20, 83, 45,1) 0%, rgba(10, 40, 20,1) 100%); }
        .level-4-bg { background: radial-gradient(circle, rgba(120, 29, 29,1) 0%, rgba(50, 10, 10,1) 100%); }
        .level-5-bg { background: radial-gradient(circle, rgba(150, 150, 170,1) 0%, rgba(40, 40, 50,1) 100%); }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div id="game-container" class="w-full min-h-screen flex flex-col items-center justify-center p-4 transition-all duration-500 level-1-bg">

        <div id="start-screen" class="text-center fade-in">
            <h1 class="text-5xl md:text-7xl font-black mb-2 text-transparent bg-clip-text bg-gradient-to-r from-sky-400 to-indigo-500">Путь Трейдера</h1>
            <p class="text-2xl font-bold mb-6 text-indigo-200">Урок 1: Реальность Профессии</p>
            <p class="text-gray-300 mb-10 max-w-lg mx-auto">Закрепите знания из первого урока. Каждое решение основано на правилах из PDF. Готовы проверить себя?</p>
            <button id="start-btn" class="bg-gradient-to-r from-sky-500 to-indigo-600 hover:from-sky-600 hover:to-indigo-700 text-white font-bold py-4 px-10 rounded-xl text-xl shadow-lg shadow-indigo-500/30 pulse-btn">Начать проверку</button>
        </div>

        <div id="main-game" class="w-full max-w-4xl mx-auto h-full flex flex-col hide">
            <!-- Global Progress Bar -->
            <div class="w-full bg-gray-700/50 rounded-full h-2.5 mb-4 border border-white/10">
                <div id="global-progress-bar" class="bg-sky-500 h-full rounded-full" style="width: 0%; transition: width 0.5s ease-in-out;"></div>
            </div>

            <div id="stats-bar" class="flex flex-wrap justify-between items-center gap-4 bg-black/30 p-3 sm:p-4 rounded-xl mb-4 border border-white/10 fade-in-up">
                <div>
                    <span class="text-xs sm:text-sm text-gray-400">Уровень</span>
                    <p class="text-base sm:text-xl font-bold text-sky-400" id="level-display"></p>
                </div>
                <div>
                    <span class="text-xs sm:text-sm text-gray-400">Капитал</span>
                    <p class="text-base sm:text-xl font-bold text-green-400" id="capital-display"></p>
                </div>
                <div>
                     <span class="text-xs sm:text-sm text-gray-400">Риск</span>
                     <div class="w-20 sm:w-24 bg-gray-700 rounded-full h-2.5">
                        <div id="risk-bar" class="bg-red-600 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div id="chart-container" class="flex-grow bg-black/30 p-4 rounded-xl border border-white/10 mb-4 fade-in-up" style="animation-delay: 0.1s; min-height: 250px;">
                <canvas id="equity-chart"></canvas>
            </div>

            <div class="bg-black/30 p-6 rounded-xl border border-white/10 fade-in-up" style="animation-delay: 0.2s;">
                <p id="scenario-text" class="text-center text-lg md:text-xl font-medium mb-6 min-h-[80px] flex items-center justify-center"></p>
                <div id="answer-buttons" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                </div>
            </div>
        </div>

        <div id="modal-overlay" class="hide fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
            <div id="level-up-modal" class="hide text-center bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-2xl border-2 border-sky-500 max-w-md mx-4 w-full">
                 <h2 class="text-3xl sm:text-4xl font-black text-sky-400 mb-4">УРОВЕНЬ ПРОЙДЕН!</h2>
                 <p id="level-up-text" class="text-gray-300 text-base sm:text-lg mb-6 sm:mb-8"></p>
                 <button id="next-level-btn" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-6 sm:px-8 rounded-lg text-base sm:text-lg w-full">Продолжить</button>
            </div>
            <div id="game-over-modal" class="hide text-center bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-2xl border-2 border-red-500 max-w-md mx-4 w-full">
                 <h2 class="text-3xl sm:text-4xl font-black text-red-500 mb-4">ЛИКВИДАЦИЯ</h2>
                 <p class="text-gray-300 text-base sm:text-lg mb-6 sm:mb-8">Ваш капитал исчерпан. Нарушение базовых правил привело к закономерному итогу. Проанализируйте ошибки и попробуйте снова!</p>
                 <button id="restart-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 sm:px-8 rounded-lg text-base sm:text-lg w-full">Начать заново</button>
            </div>
             <div id="game-win-modal" class="hide text-center bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-2xl border-2 border-green-500 max-w-md mx-4 w-full">
                 <h2 class="text-3xl sm:text-4xl font-black text-green-400 mb-4">УРОК 1 УСВОЕН!</h2>
                 <p class="text-gray-300 text-base sm:text-lg mb-6 sm:mb-8">Вы безупречно освоили теорию! Теперь вы понимаете, что трейдинг - это профессия, требующая дисциплины и системы. Готовы к следующему уроку?</p>
                 <button id="restart-win-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 sm:px-8 rounded-lg text-base sm:text-lg w-full">Пройти снова</button>
            </div>
        </div>

    </div>

    <script>
        const gameContainer = document.getElementById('game-container');
        const startScreen = document.getElementById('start-screen');
        const mainGame = document.getElementById('main-game');
        const startBtn = document.getElementById('start-btn');
        const answerButtonsContainer = document.getElementById('answer-buttons');
        const levelDisplay = document.getElementById('level-display');
        const capitalDisplay = document.getElementById('capital-display');
        const riskBar = document.getElementById('risk-bar');
        const globalProgressBar = document.getElementById('global-progress-bar');
        const scenarioText = document.getElementById('scenario-text');
        const modalOverlay = document.getElementById('modal-overlay');
        const levelUpModal = document.getElementById('level-up-modal');
        const levelUpText = document.getElementById('level-up-text');
        const nextLevelBtn = document.getElementById('next-level-btn');
        const gameOverModal = document.getElementById('game-over-modal');
        const restartBtn = document.getElementById('restart-btn');
        const gameWinModal = document.getElementById('game-win-modal');
        const restartWinBtn = document.getElementById('restart-win-btn');
        const chartContainer = document.getElementById('chart-container');

        const levels = [
            { name: "Жесткая правда и принципы", startCapital: 10000, scenarios: 10, marginCall: 8000, class: 'level-1-bg', levelUpMsg: "Вы усвоили жесткую правду и базовые принципы. Теперь пора формализовать свой подход." },
            { name: "Контракт и инфраструктура", startCapital: 15000, scenarios: 10, marginCall: 11000, class: 'level-2-bg', levelUpMsg: "Ваши правила и инструменты готовы. Готовы ли вы столкнуться с главными заблуждениями рынка?" },
            { name: "Борьба с иллюзиями", startCapital: 20000, scenarios: 10, marginCall: 15000, class: 'level-3-bg', levelUpMsg: "Вы больше не ищете 'грааль'. Теперь предстоит самое сложное — битва с собственными эмоциями." },
            { name: "Антитильт и психология", startCapital: 30000, scenarios: 10, marginCall: 22000, class: 'level-4-bg', levelUpMsg: "Вы научились контролировать тильт и принимать взвешенные решения. Остался финальный шаг к мышлению профи." },
            { name: "Мышление профессионала", startCapital: 50000, scenarios: 10, marginCall: 35000, class: 'level-5-bg', levelUpMsg: "ПОБЕДА!" },
        ];
        
        const scenariosByLevel = {
            1: [
                 { text: 'Согласно 1 уроку, трейдинг — это в первую очередь...', choices: [ { text: 'Способ быстро разбогатеть.', correct: false, impact: -1000 }, { text: 'Профессия, требующая 12-24 месяцев на освоение.', correct: true, impact: 500 }, { text: 'Игра на удачу, похожая на казино.', correct: false, impact: -800 }, { text: 'Поиск секретного индикатора.', correct: false, impact: -500 } ] },
                 { text: 'Почему, согласно 1 уроку, большинство трейдеров теряет деньги?', choices: [ { text: 'Им не хватает удачи.', correct: false, impact: -500 }, { text: 'Они игнорируют базовые действия: дневник, разбор ошибок, дисциплину.', correct: true, impact: 700 }, { text: 'Рынок манипулируют крупные игроки.', correct: false, impact: -800 }, { text: 'У них нет нужного индикатора.', correct: false, impact: -1000 } ] },
                 { text: 'Вы хотите начать торговать на полную ставку. Что 1 урок называет ОБЯЗАТЕЛЬНЫМ условием?', choices: [ { text: 'Найти прибыльного робота.', correct: false, impact: -1000 }, { text: 'Создать финансовую подушку на 6-12 месяцев расходов.', correct: true, impact: 1000 }, { text: 'Взять кредит на депозит побольше.', correct: false, impact: -2000 }, { text: 'Получить диплом экономиста.', correct: false, impact: -200 } ] },
                 { text: 'Что является настоящим капиталом трейдера, который не может отнять рынок?', choices: [ { text: 'Размер его депозита.', correct: false, impact: -500 }, { text: 'Навык, построенный на системе и статистике.', correct: true, impact: 1000 }, { text: 'Количество подписчиков в соцсетях.', correct: false, impact: -200 }, { text: 'Секретный индикатор.', correct: false, impact: -800 } ] },
                 { text: 'Что 1 урок называет "фантомом", за которым не стоит гнаться?', choices: [ { text: 'Стабильная ежемесячная прибыль.', correct: false, impact: -500 }, { text: '"Джекпот" или одна большая удачная сделка.', correct: true, impact: 400 }, { text: 'Собственная торговая система.', correct: false, impact: -800 }, { text: 'Финансовая подушка.', correct: false, impact: -200 } ] },
                 { text: 'Для чего нужно сформулировать личные принципы (фильтры решений)?', choices: [ { text: 'Чтобы опубликовать их в соцсетях и выглядеть умным.', correct: false, impact: -300 }, { text: 'Чтобы в моменты эмоций не думать, а выполнять заранее принятые решения.', correct: true, impact: 800 }, { text: 'Чтобы никогда их не нарушать, даже если ситуация изменилась.', correct: false, impact: -500 }, { text: 'Это формальность, которая не влияет на результат.', correct: false, impact: -1000 } ] },
                 { text: 'Вы достигли заранее установленного дневного лимита просадки (DD). Ваши действия по правилам?', choices: [ { text: 'Уменьшаю размер позиции и продолжаю, чтобы отыграться.', correct: false, impact: -1500 }, { text: 'Немедленно останавливаю торговлю на сегодня.', correct: true, impact: 1000 }, { text: 'Ищу "сверхнадежную" сделку, чтобы вернуть потери.', correct: false, impact: -2000 }, { text: 'Перехожу на демо-счет до конца дня.', correct: false, impact: -200 } ] },
                 { text: 'Как, согласно 1 уроку, связаны физиология и трейдинг?', choices: [ { text: 'Спортсмены — лучшие трейдеры.', correct: false, impact: -300 }, { text: 'Плохая физиология (недосып, стресс) ведет к плохим торговым решениям.', correct: true, impact: 700 }, { text: 'Чем меньше спишь, тем больше времени на торговлю.', correct: false, impact: -1500 }, { text: 'Никак не связаны, главное — ум.', correct: false, impact: -800 } ] },
                 { text: 'Что такое "предрешённые решения", о которых говорится в 1 уроке?', choices: [ { text: 'Слепое копирование чужих сделок.', correct: false, impact: -700 }, { text: 'Заранее прописанные принципы и правила, которые выполняются в момент эмоций.', correct: true, impact: 900 }, { text: 'Торговля по интуиции.', correct: false, impact: -1000 }, { text: 'Решения, принятые за вас вашим ментором.', correct: false, impact: -400 } ] },
                 { text: 'Если у вас нет финансовой подушки, какой стиль торговли будет правильным?', choices: [ { text: 'Агрессивный, чтобы быстрее ее создать.', correct: false, impact: -2500 }, { text: 'Никаких агрессивных рисков, фокус на обучении и симуляции.', correct: true, impact: 500 }, { text: 'Торговля с максимальным плечом.', correct: false, impact: -3000 }, { text: 'Торговля на заемные средства.', correct: false, impact: -4000 } ] }
            ],
            2: [
                 { text: 'Какова главная цель "Контракта трейдера на 90 дней"?', choices: [ { text: 'Заработать максимальную прибыль за 90 дней.', correct: false, impact: -1500 }, { text: 'Превратить намерение в обязательные, измеримые действия с фокусом на навык и дисциплину.', correct: true, impact: 1000 }, { text: 'Протестировать 20 разных стратегий.', correct: false, impact: -800 }, { text: 'Доказать всем, что ты можешь быть трейдером.', correct: false, impact: -500 } ] },
                 { text: 'Какой стартовый риск на сделку рекомендуется в "Контракте"?', choices: [ { text: '5-10% от депозита, чтобы быстро расти.', correct: false, impact: -2000 }, { text: '0.25-0.5% от депозита.', correct: true, impact: 800 }, { text: '1-2% от депозита.', correct: false, impact: -500 }, { text: 'Фиксированная сумма, например, 100$.', correct: false, impact: -800 } ] },
                 { text: 'Что включает в себя утренний ритуал трейдера?', choices: [ { text: 'Чтение чатов и новостей, чтобы понять, куда пойдет рынок.', correct: false, impact: -800 }, { text: 'Скан активов, определение ключевых уровней и построение сценариев.', correct: true, impact: 900 }, { text: 'Медитацию и визуализацию больших денег.', correct: false, impact: -400 }, { text: 'Кофе и просмотр котировок в телефоне.', correct: false, impact: -600 } ] },
                 { text: 'Какова задача вечернего ритуала?', choices: [ { text: 'Забыть о неудачном дне как можно скорее.', correct: false, impact: -700 }, { text: 'Разбор сделок (скриншоты/видео) и фиксация уроков в дневнике.', correct: true, impact: 1000 }, { text: 'Поиск сделок на следующий день.', correct: false, impact: -500 }, { text: 'Подсчет прибыли или убытков.', correct: false, impact: -300 } ] },
                 { text: 'Какова итоговая цель первых 90 дней по контракту?', choices: [ { text: 'Удвоить депозит.', correct: false, impact: -2000 }, { text: 'Получить статистику (WinRate, Avg Win/Loss) и добиться нулевой тильт-активности.', correct: true, impact: 1200 }, { text: 'Найти 5 новых прибыльных сетапов.', correct: false, impact: -800 }, { text: 'Совершить не менее 500 сделок.', correct: false, impact: -1000 } ] },
                 { text: 'Какая основная задача дневника сделок?', choices: [ { text: 'Отчет для налоговой.', correct: false, impact: -300 }, { text: 'Собрать данные для анализа, выявления ошибок и поиска точек роста.', correct: true, impact: 1000 }, { text: 'Хвастаться прибыльными сделками.', correct: false, impact: -200 }, { text: 'Просто формальность, которую требуют все курсы.', correct: false, impact: -800 } ] },
                 { text: 'Для чего нужна папка "Разборы" с видео/скринкастами сессий?', choices: [ { text: 'Для создания контента для YouTube-канала.', correct: false, impact: -500 }, { text: 'Чтобы объективно увидеть свои действия со стороны и зафиксировать уроки.', correct: true, impact: 1100 }, { text: 'Чтобы было что показать ментору, если он появится.', correct: false, impact: -400 }, { text: 'Для хранения архива на случай споров с брокером.', correct: false, impact: -700 } ] },
                 { text: 'Какова цель чек-листов "Перед входом", "После сделки", "Конец дня"?', choices: [ { text: 'Замедлить торговлю и пропустить все хорошие входы.', correct: false, impact: -1000 }, { text: 'Снять нагрузку с памяти и повысить дисциплину, гарантируя выполнение всех шагов.', correct: true, impact: 1200 }, { text: 'Усложнить процесс трейдинга.', correct: false, impact: -800 }, { text: 'Это нужно только для новичков, профессионалы держат все в голове.', correct: false, impact: -1500 } ] },
                 { text: 'Что 1 урок рекомендует делать с периодами "тишины" на рынке, когда нет сетапов?', choices: [ { text: 'Искать сделки на младших таймфреймах.', correct: false, impact: -1500 }, { text: 'Ничего не делать. Ждать — это тоже стратегия.', correct: true, impact: 1000 }, { text: 'Рисовать новые линии на графике, пока что-то не появится.', correct: false, impact: -500 }, { text: 'Открывать сделки с меньшим риском, чтобы "почувствовать" рынок.', correct: false, impact: -1800 } ] },
                 { text: 'Понятие "активы в игре" означает, что нужно торговать...', choices: [ { text: 'Всеми активами подряд.', correct: false, impact: -1000 }, { text: 'Только активами, которые показывают направленное движение и высокий объем.', correct: true, impact: 900 }, { text: 'Самыми дешевыми активами.', correct: false, impact: -700 }, { text: 'Активами, которые советуют в новостях.', correct: false, impact: -1200 } ] }
            ],
            3: [
                 { text: 'Вы наткнулись на заблуждение "Нужен правильный индикатор и всё". Какова реальность согласно 1 уроку?', choices: [ { text: 'Это правда, осталось только найти этот индикатор.', correct: false, impact: -2000 }, { text: 'Индикаторы вторичны. Важнее контекст, ликвидность и дисциплина.', correct: true, impact: 1000 }, { text: 'Чем больше индикаторов на графике, тем точнее прогноз.', correct: false, impact: -1500 }, { text: 'Индикаторы вообще не работают.', correct: false, impact: -800 } ] },
                 { text: 'Ваш друг говорит: "Возьму кредит, закину на биржу и быстро отобью". Какова реальность такого подхода?', choices: [ { text: 'Отличный план, если он уверен в стратегии.', correct: false, impact: -1500 }, { text: 'Давление заемных денег ломает психику, рождает тильт и гарантированно ведет к ошибкам.', correct: true, impact: 1200 }, { text: 'Это сработает, если торговать с минимальным плечом.', correct: false, impact: -1000 }, { text: 'Нужно просто найти хорошего аналитика и следовать его сигналам.', correct: false, impact: -1800 } ] },
                 { text: 'Вы торгуете весь день и совершили 20 сделок, но остались при своих. Какое заблуждение вы реализуете?', choices: [ { text: 'Принцип "Практика ведет к совершенству".', correct: false, impact: -500 }, { text: 'Заблуждение "Чем больше торгую, тем больше зарабатываю".', correct: true, impact: 900 }, { text: 'Стратегию скальпинга.', correct: false, impact: -300 }, { text: 'Диверсификацию рисков.', correct: false, impact: -800 } ] },
                 { text: 'Рынок стоит в "боковике", нет явного движения. Какая сделка будет лучшей в таких условиях?', choices: [ { text: 'Покупка на пробой верхней границы.', correct: false, impact: -1000 }, { text: 'Продажа на пробой нижней границы.', correct: false, impact: -1000 }, { text: 'Сделка, которую вы не сделали, дождавшись лучших условий.', correct: true, impact: 800 }, { text: 'Торговля внутри диапазона с плечом х20.', correct: false, impact: -2500 } ] },
                 { text: 'Вы не ведете дневник. Почему, согласно 1 уроку, вы не можете улучшить свои результаты?', choices: [ { text: 'Потому что без дневника нельзя платить налоги.', correct: false, impact: -300 }, { text: 'Потому что вы не видите свои повторяющиеся ошибки и не можете их исправить.', correct: true, impact: 1000 }, { text: 'Потому что ментор не сможет вас проверить.', correct: false, impact: -500 }, { text: 'Потому что это плохая примета.', correct: false, impact: -100 } ] },
                 { text: 'Какой вопрос нужно задать себе, чтобы понять контекст сделки?', choices: [ { text: 'Сколько я могу заработать?', correct: false, impact: -1000 }, { text: 'Кто находится по ту сторону сделки? Где стопы толпы?', correct: true, impact: 900 }, { text: 'Что говорят об этом активе в Telegram-каналах?', correct: false, impact: -1200 }, { text: 'Какой индикатор сейчас в зеленой зоне?', correct: false, impact: -800 } ] },
                 { text: 'В чем ключевое отличие профессионального подхода от любительского?', choices: [ { text: 'Профессионалы никогда не ошибаются.', correct: false, impact: -800 }, { text: 'Профессионал строит систему, ведет статистику и работает над ошибками, любитель ищет джекпот.', correct: true, impact: 1100 }, { text: 'Профессионалы используют более сложные индикаторы.', correct: false, impact: -1000 }, { text: 'Профессионалы торгуют на большие суммы.', correct: false, impact: -500 } ] },
                 { text: 'Что является гарантией результата в трейдинге, согласно Q&A из 1 урока?', choices: [ { text: 'Высокий интеллект.', correct: false, impact: -800 }, { text: 'Система + дисциплина + время в рынке.', correct: true, impact: 900 }, { text: 'Большой депозит.', correct: false, impact: -1000 }, { text: 'Удача.', correct: false, impact: -1200 } ] },
                 { text: 'Торговля "по ощущениям" и перемещение стопов без плана — это...', choices: [ { text: 'Проявление профессиональной интуиции.', correct: false, impact: -1200 }, { text: 'Системное нарушение простых правил, ведущее к убыткам.', correct: true, impact: 600 }, { text: 'Гибкий подход к рынку.', correct: false, impact: -800 }, { text: 'Нормально для начинающих.', correct: false, impact: -500 } ] },
                 { text: 'Зачем нужно понимать механику рынка (заявки, ликвидность)?', choices: [ { text: 'Чтобы предсказывать будущее со 100% точностью.', correct: false, impact: -1000 }, { text: 'Без этого любой паттерн на графике превращается в подбрасывание монетки.', correct: true, impact: 700 }, { text: 'Чтобы хвастаться сложными терминами в чатах.', correct: false, impact: -200 }, { text: 'Это не обязательно, главное — индикаторы.', correct: false, impact: -1500 } ] },
            ],
            4: [
                 { text: 'Вы поймали тильт после серии убытков. Как его лечить согласно "жесткой правде" из 1 урока?', choices: [ { text: 'Собрать волю в кулак и отыграться.', correct: false, impact: -1500 }, { text: 'Заранее прописанными ограничениями, например, лимитом дневной просадки.', correct: true, impact: 800 }, { text: 'Посмотреть мотивирующее видео и снова в бой.', correct: false, impact: -500 }, { text: 'Увеличить размер позиции, чтобы быстрее вернуть убыток.', correct: false, impact: -2000 } ] },
                 { text: 'Вы получили убыток. Ваш первый импульс — "отбить" его. Что предписывает антитильт-протокол?', choices: [ { text: 'Немедленно найти новую сделку с удвоенным риском.', correct: false, impact: -3000 }, { text: 'Сделать паузу, закрыть терминал, перечитать контракт.', correct: true, impact: 1500 }, { text: 'Пожаловаться в чате на манипуляторов.', correct: false, impact: -500 }, { text: 'Продолжать торговать, но с большей агрессией.', correct: false, impact: -2500 } ] },
                 { text: 'Вы чувствуете эйфорию после 5 прибыльных сделок подряд и хотите увеличить риск без причины. Это...', choices: [ { text: 'Признак того, что вы "почувствовали" рынок.', correct: false, impact: -2000 }, { text: 'Триггер тильта, который нужно распознать и остановить согласно протоколу.', correct: true, impact: 1200 }, { text: 'Отличная возможность, чтобы заработать больше.', correct: false, impact: -2500 }, { text: 'Сигнал к тому, чтобы начать обучать других.', correct: false, impact: -800 } ] },
                 { text: 'Вы вернулись в рынок после паузы по антитильт-протоколу. С каким размером лота вы должны войти?', choices: [ { text: 'С удвоенным, чтобы компенсировать время простоя.', correct: false, impact: -2800 }, { text: 'Только с микро-лотом.', correct: true, impact: 1000 }, { text: 'Со стандартным, как будто ничего не было.', correct: false, impact: -1500 }, { text: 'Не входить в рынок до конца дня.', correct: false, impact: -500 } ] },
                 { text: 'Как бороться с тильтом согласно 1 уроку?', choices: [ { text: 'Силой воли и самовнушением.', correct: false, impact: -1500 }, { text: 'Заранее прописанными правилами: лимит дня, стоп-торговля, пауза, перезапуск с микро-размером.', correct: true, impact: 1300 }, { text: 'Просмотром котировок в реальном времени без остановки.', correct: false, impact: -1000 }, { text: 'Принятием успокоительных.', correct: false, impact: -800 } ] },
                 { text: 'Вы достигли дневного лимита просадки, но видите "верняковый" сетап. Что делать?', choices: [ { text: 'Войти, ведь это шанс вернуть все потери.', correct: false, impact: -3500 }, { text: 'Соблюдать правило "стоп-торговля" из контракта. Правила важнее одного сетапа.', correct: true, impact: 1500 }, { text: 'Войти с половиной риска.', correct: false, impact: -2000 }, { text: 'Попросить друга войти в эту сделку за вас.', correct: false, impact: -1000 } ] },
                 { text: 'Что из перечисленного является триггером тильта, согласно 1 уроку?', choices: [ { text: 'Строгое следование плану.', correct: false, impact: 200 }, { text: 'Желание "отбить" убыток и серия импульсивных входов.', correct: true, impact: -1000 }, { text: 'Ведение дневника сделок.', correct: false, impact: 100 }, { text: 'Утренний анализ рынка.', correct: false, impact: 50 } ] },
                 { text: 'Вы не выспались и чувствуете себя уставшим. Как это должно повлиять на вашу торговлю сегодня?', choices: [ { text: 'Никак, профессионал торгует в любом состоянии.', correct: false, impact: -2000 }, { text: 'Стоит пропустить торговый день или торговать микро-лотом, так как "плохая физиология = плохие решения".', correct: true, impact: 800 }, { text: 'Нужно торговать более агрессивно, чтобы взбодриться.', correct: false, impact: -2500 }, { text: 'Выпить много кофе и торговать как обычно.', correct: false, impact: -1500 } ] },
                 { text: 'Ключевая идея "Контракта" и "Протоколов" заключается в том, чтобы...', choices: [ { text: 'Сделать трейдинг максимально сложным и забюрократизированным.', correct: false, impact: -1000 }, { text: 'Перенести принятие ключевых решений из эмоционального состояния (в моменте) в рациональное (заранее).', correct: true, impact: 1500 }, { text: 'Создать иллюзию контроля над рынком.', correct: false, impact: -1200 }, { text: 'Впечатлить своего ментора.', correct: false, impact: -500 } ] },
                 { text: 'Что такое "Антитильт-протокол"?', choices: [ { text: 'Заклинание для успокоения нервов.', correct: false, impact: -200 }, { text: 'Заранее прописанный план действий при появлении триггеров тильта (например, желание отыграться).', correct: true, impact: 1200 }, { text: 'Таблетки, которые помогают сохранять спокойствие.', correct: false, impact: -500 }, { text: 'Кнопка "паника" в терминале.', correct: false, impact: -800 } ] }
            ],
            5: [
                 { text: 'Какой ориентир по развитию дает 1 урок на первые 3 месяца?', choices: [ { text: 'Заработать первые 1000$.', correct: false, impact: -1500 }, { text: 'Освоить механику, дисциплину, 2 базовых сетапа и сделать 50-100 микро-сделок с ведением дневника.', correct: true, impact: 1000 }, { text: 'Изучить 10 разных сетапов.', correct: false, impact: -1000 }, { text: 'Начать управлять деньгами инвесторов.', correct: false, impact: -3000 } ] },
                 { text: 'На каком этапе, согласно ориентиру пути, можно начинать постепенное увеличение размера позиции?', choices: [ { text: 'С первого дня, чтобы быстрее расти.', correct: false, impact: -2500 }, { text: 'На этапе 6-12 месяцев, после получения доказанного математического ожидания.', correct: true, impact: 1200 }, { text: 'После 0-3 месяцев.', correct: false, impact: -1500 }, { text: 'Никогда, всегда нужно торговать микро-лотом.', correct: false, impact: -500 } ] },
                 { text: 'Что такое "Expectancy" (математическое ожидание), которое упоминается в ориентире?', choices: [ { text: 'Ваши ожидания по прибыли на месяц.', correct: false, impact: -800 }, { text: 'Статистический показатель, который показывает, сколько вы в среднем зарабатываете или теряете на каждой сделке.', correct: true, impact: 1000 }, { text: 'Надежда на то, что сделка будет прибыльной.', correct: false, impact: -1200 }, { text: 'Прогноз аналитика.', correct: false, impact: -500 } ] },
                 { text: 'Вы на правильном пути, если...', choices: [ { text: 'Каждый ваш день закрывается в плюс.', correct: false, impact: -1500 }, { text: 'У вас есть "Контракт на 90 дней", вы знаете свой дневной DD и ведете разбор сделок.', correct: true, impact: 1300 }, { text: 'Вы нашли трейдера, чьи сигналы копируете.', correct: false, impact: -2000 }, { text: 'Вы прочитали 20 книг по трейдингу.', correct: false, impact: -800 } ] },
                 { text: 'Когда можно увольняться с основной работы, согласно Q&A?', choices: [ { text: 'Как только закрыл первую прибыльную неделю.', correct: false, impact: -2500 }, { text: 'Когда есть финансовая подушка и стабильная положительная статистика за несколько месяцев.', correct: true, impact: 1500 }, { text: 'Когда начальник тебя достал.', correct: false, impact: -500 }, { text: 'Никогда, трейдинг — это не работа.', correct: false, impact: -1000 } ] },
                 { text: 'Вся суть первого урока сводится к тому, чтобы...', choices: [ { text: 'Научить вас конкретному сетапу для входа.', correct: false, impact: -1200 }, { text: 'Перестроить мышление: от охоты за "ракетами" к освоению профессии через систему и дисциплину.', correct: true, impact: 1500 }, { text: 'Напугать вас и отговорить от трейдинга.', correct: false, impact: -500 }, { text: 'Продать вам продвинутый курс.', correct: false, impact: -800 } ] },
                 { text: 'Вы подписали "Контракт". Теперь ваши торговые решения принимаются через...', choices: [ { text: 'Эмоции и интуицию.', correct: false, impact: -2000 }, { text: 'Призмы этого контракта, а не через эмоции.', correct: true, impact: 1200 }, { text: 'Советы из Telegram-каналов.', correct: false, impact: -1800 }, { text: 'Подбрасывание монетки.', correct: false, impact: -1000 } ] },
                 { text: 'Профессиональный трейдер в "тихий" день, скорее всего...', choices: [ { text: 'Совершит ноль сделок.', correct: true, impact: 800 }, { text: 'Потеряет деньги из-за овертрейдинга.', correct: false, impact: -1500 }, { text: 'Будет искать экзотические активы для торговли.', correct: false, impact: -1200 }, { text: 'Заработает больше обычного.', correct: false, impact: -1000 } ] },
                 { text: 'Какова цель этапа 12-24 месяцев?', choices: [ { text: 'Наконец-то начать зарабатывать.', correct: false, impact: -1000 }, { text: 'Достичь устойчивости, расширить набор сетапов и системно масштабировать свой размер позиции.', correct: true, impact: 1400 }, { text: 'Начать обучать других.', correct: false, impact: -800 }, { text: 'Вернуть все деньги, потерянные в первый год.', correct: false, impact: -1500 } ] },
                 { text: 'Итоговая мысль первого урока: "С этого момента решения принимаешь через контракт, а не через эмоции". Это означает...', choices: [ { text: 'Трейдинг — это скучная работа по правилам.', correct: false, impact: -500 }, { text: 'Ваша система и заранее принятые решения должны иметь приоритет над сиюминутными импульсами.', correct: true, impact: 1500 }, { text: 'Эмоциям нет места в трейдинге.', correct: false, impact: -800 }, { text: 'Нужно стать роботом.', correct: false, impact: -1000 } ] }
            ]
        };
        
        let gameState = {};
        let equityChart;
        let audioSynth;
        let isAudioEnabled = false;

        function initGame() {
            startScreen.classList.remove('hide');
            mainGame.classList.add('hide');
            modalOverlay.classList.add('hide');
            
            if (!audioSynth && typeof Tone !== 'undefined') {
                try {
                    audioSynth = {
                        correct: new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 } }).toDestination(),
                        wrong: new Tone.Synth({ oscillator: { type: "square" }, envelope: { attack: 0.005, decay: 0.2, sustain: 0, release: 0.2 } }).toDestination(),
                        click: new Tone.MembraneSynth({ pitchDecay: 0.008, octaves: 2, envelope: { attack: 0.001, decay: 0.2, sustain: 0 } }).toDestination(),
                        levelUp: new Tone.PolySynth(Tone.Synth).toDestination()
                    };
                    isAudioEnabled = true;
                } catch (e) { console.error("Could not initialize audio engine.", e); isAudioEnabled = false; }
            } else if (typeof Tone === 'undefined') { console.warn("Tone.js not loaded. No sound."); isAudioEnabled = false; }
        }
        
        async function startGame() {
            if (isAudioEnabled && Tone.context.state !== 'running') {
                try { await Tone.start(); console.log("Audio context started"); } catch(e) { console.error("Could not start audio.", e); isAudioEnabled = false; }
            }
            playSound('click');
            startScreen.classList.add('hide');
            mainGame.classList.remove('hide');
            loadLevel(0);
        }

        function loadLevel(levelIndex) {
            const levelData = levels[levelIndex];
            const scenarioPool = scenariosByLevel[levelIndex + 1];

            gameState = {
                level: levelIndex,
                capital: levelData.startCapital,
                marginCall: levelData.marginCall,
                scenarios: shuffleArray([...scenarioPool]).slice(0, levelData.scenarios),
                currentScenario: 0,
                equityData: [levelData.startCapital]
            };
            
            levelDisplay.textContent = `${levelIndex + 1}: ${levelData.name}`;
            updateCapitalDisplay();
            updateGlobalProgress();
            gameContainer.className = `w-full min-h-screen flex flex-col items-center justify-center p-4 transition-all duration-500 ${levelData.class}`;
            
            setupChart();
            displayScenario();
        }

        function displayScenario() {
            if (gameState.currentScenario >= gameState.scenarios.length) {
                levelUp();
                return;
            }

            const scenario = gameState.scenarios[gameState.currentScenario];
            scenarioText.textContent = scenario.text;
            
            const shuffledChoices = shuffleArray([...scenario.choices]);

            answerButtonsContainer.innerHTML = '';
            shuffledChoices.forEach(choice => {
                const button = document.createElement('button');
                button.textContent = choice.text;
                button.className = 'answer-btn w-full text-left p-4 rounded-lg bg-gray-700/50 hover:bg-gray-600/50 border border-white/20 backdrop-blur-sm';
                button.onclick = () => selectAnswer(choice);
                answerButtonsContainer.appendChild(button);
            });
        }
        
        function selectAnswer(choice) {
            playSound('click');
            const buttons = answerButtonsContainer.querySelectorAll('button');
            buttons.forEach(btn => {
                btn.disabled = true;
                const btnChoice = gameState.scenarios[gameState.currentScenario].choices.find(c => c.text === btn.textContent);
                if (btnChoice.correct) btn.classList.add('btn-correct');
                else if (btn.textContent === choice.text) btn.classList.add('btn-wrong');
            });

            gameState.capital += choice.impact;
            updateCapitalDisplay();
            
            if (choice.correct) playSound('correct');
            else {
                playSound('wrong');
                gameContainer.classList.add('screen-shake');
                setTimeout(() => gameContainer.classList.remove('screen-shake'), 300);
            }

            if (gameState.capital <= gameState.marginCall) {
                setTimeout(gameOver, 2000);
                return;
            }

            gameState.currentScenario++;
            updateGlobalProgress();
            setTimeout(displayScenario, 2000);
        }
        
        function levelUp() {
            const currentLevel = gameState.level;
            if (currentLevel + 1 >= levels.length) {
                gameWin(); return;
            }
            playSound('levelUp');
            modalOverlay.classList.remove('hide');
            levelUpModal.classList.remove('hide');
            levelUpText.textContent = levels[currentLevel].levelUpMsg;
            gameState.level++;
        }
        
        function proceedToNextLevel() {
            playSound('click');
            modalOverlay.classList.add('hide');
            levelUpModal.classList.add('hide');
            loadLevel(gameState.level);
        }

        function gameOver() {
            playSound('wrong');
            modalOverlay.classList.remove('hide');
            gameOverModal.classList.remove('hide');
        }
        
        function gameWin() {
            playSound('levelUp');
            modalOverlay.classList.remove('hide');
            gameWinModal.classList.remove('hide');
            globalProgressBar.style.width = '100%';
        }

        function restartGame() {
            playSound('click');
            initGame();
        }

        function updateCapitalDisplay() {
            capitalDisplay.textContent = `$${gameState.capital.toLocaleString()}`;
            gameState.equityData.push(gameState.capital);
            updateChart();
            
            const level = levels[gameState.level];
            const capitalRange = level.startCapital - level.marginCall;
            const capitalLost = level.startCapital - gameState.capital;
            const riskPercent = Math.max(0, Math.min(100, (capitalLost / capitalRange) * 100));
            riskBar.style.width = `${riskPercent}%`;
        }

        function updateGlobalProgress() {
            const totalScenarios = levels.length * levels[0].scenarios;
            const scenariosCompleted = gameState.level * levels[0].scenarios + gameState.currentScenario;
            const progress = (scenariosCompleted / totalScenarios) * 100;
            globalProgressBar.style.width = `${progress}%`;
        }
        
        function setupChart() {
            if (typeof Chart === 'undefined') {
                console.error("Chart.js not loaded.");
                chartContainer.innerHTML = `<div class="flex items-center justify-center h-full text-gray-400">График недоступен</div>`;
                return;
            }

            const canvas = document.getElementById('equity-chart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (equityChart) equityChart.destroy();

            try {
                equityChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: gameState.equityData.map((_, i) => i === 0 ? 'Start' : `S${i}`),
                        datasets: [{ label: 'Капитал', data: gameState.equityData, borderColor: '#38bdf8', backgroundColor: 'rgba(56, 189, 248, 0.1)', fill: true, tension: 0.4, pointRadius: 4, pointBackgroundColor: '#38bdf8' }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { color: 'rgba(255,255,255,0.5)' }, grid: { color: 'rgba(255,255,255,0.1)' } }, x: { ticks: { color: 'rgba(255,255,255,0.5)' }, grid: { display: false } } } }
                });
            } catch (e) {
                console.error("Chart creation error:", e);
                chartContainer.innerHTML = `<div class="flex items-center justify-center h-full text-gray-400">Ошибка при загрузке графика</div>`;
            }
        }
        
        function updateChart() {
             if (!equityChart) return;
             equityChart.data.labels = gameState.equityData.map((_, i) => i === 0 ? 'Start' : `S${i}`);
             equityChart.data.datasets[0].data = gameState.equityData;
             equityChart.update();
        }

        function playSound(type) {
            if (!isAudioEnabled || !audioSynth) return;
            try {
                const now = Tone.now();
                if (type === 'correct') audioSynth.correct.triggerAttackRelease("E5", "8n", now);
                else if (type === 'wrong') audioSynth.wrong.triggerAttackRelease("C3", "8n", now);
                else if (type === 'click') audioSynth.click.triggerAttackRelease("C2", "8n", now);
                else if (type === 'levelUp') audioSynth.levelUp.triggerAttackRelease(["C4", "E4", "G4", "C5"], "8n", now);
            } catch (e) { console.error("Audio play error:", e); }
        }
        
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; }
            return array;
        }

        startBtn.addEventListener('click', startGame);
        nextLevelBtn.addEventListener('click', proceedToNextLevel);
        restartBtn.addEventListener('click', restartGame);
        restartWinBtn.addEventListener('click', restartGame);

        window.onload = initGame;
    </script>
</body>
</html>