<!DOCTYPE html>
<!-- VERSION: v1.1.0 — Hook-enabled; based on Lesson 1 engine -->
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Путь Трейдера: Урок 2 — Техническая среда скальпера</title>
  <!-- CDN-библиотеки (онлайн): Tailwind, Chart.js, Tone.js -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
  <style>
    body{font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji",sans-serif;overflow-y:auto;touch-action:manipulation}
    .hide{display:none!important}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes fadeInUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
    @keyframes screenShake{0%,100%{transform:translateX(0)}20%{transform:translateX(-5px)}40%{transform:translateX(5px)}60%{transform:translateX(-5px)}80%{transform:translateX(5px)}}
    .fade-in{animation:fadeIn .5s ease-in-out forwards}
    .fade-in-up{animation:fadeInUp .5s ease-in-out forwards}
    .pulse-btn{animation:pulse 2s infinite ease-in-out}
    .screen-shake{animation:screenShake .3s linear}
    .answer-btn{transition:all .2s ease-out;box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -2px rgba(0,0,0,.1)}
    .answer-btn:hover{transform:translateY(-4px) scale(1.02);box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.1)}
    .answer-btn:disabled{cursor:not-allowed;opacity:.7}
    .btn-correct{background:#22c55e!important;border-color:#16a34a!important;color:#fff;transform:scale(1.05)}
    .btn-wrong{background:#ef4444!important;border-color:#dc2626!important;color:#fff;opacity:.6}
    #game-container{transition:background 1s ease-in-out}
    .level-1-bg{background:radial-gradient(circle,rgba(23,37,84,1) 0%,rgba(12,20,45,1) 100%)}
    .level-2-bg{background:radial-gradient(circle,rgba(55,48,163,1) 0%,rgba(20,15,60,1) 100%)}
    .level-3-bg{background:radial-gradient(circle,rgba(20,83,45,1) 0%,rgba(10,40,20,1) 100%)}
    .level-4-bg{background:radial-gradient(circle,rgba(120,29,29,1) 0%,rgba(50,10,10,1) 100%)}
    .level-5-bg{background:radial-gradient(circle,rgba(150,150,170,1) 0%,rgba(40,40,50,1) 100%)}
    /* DEV panel (по желанию, Shift+D) */
    .dev-badge{position:fixed;top:.5rem;left:.5rem;z-index:60;background:#0ea5e9;color:#fff;font-weight:700;font-size:.75rem;padding:.25rem .5rem;border-radius:.375rem;box-shadow:0 2px 8px rgba(0,0,0,.2);display:none}
    .dev-panel{position:fixed;bottom:0;left:0;right:0;z-index:60;background:rgba(17,24,39,.98);border-top:1px solid rgba(255,255,255,.08);backdrop-filter:saturate(140%) blur(6px);padding:.75rem 1rem;display:none}
    .dev-panel *{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace}
    .dev-panel h3{font-size:.9rem;margin:0 0 .5rem 0;color:#93c5fd}
    .dev-row{display:flex;gap:.5rem;align-items:center;margin-bottom:.5rem}
    .dev-log{max-height:30vh;overflow:auto;font-size:.75rem;line-height:1.2;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:.5rem;padding:.5rem;color:#d1d5db}
    .dev-btn{font-size:.75rem;padding:.35rem .6rem;border-radius:.375rem;border:1px solid rgba(255,255,255,.12);background:#111827;color:#e5e7eb}
    .dev-btn:hover{background:#0b1220}
  </style>
</head>
<body class="bg-gray-900 text-white">

  <div id="game-container" class="w-full min-h-screen flex flex-col items-center justify-center p-4 transition-all duration-500 level-1-bg">

    <div id="start-screen" class="text-center fade-in">
      <h1 class="text-5xl md:text-7xl font-black mb-2 text-transparent bg-clip-text bg-gradient-to-r from-sky-400 to-indigo-500">
        Путь Трейдера
      </h1>
      <p class="text-2xl font-bold mb-6 text-indigo-200">Урок 2: Техническая среда скальпера</p>
      <p class="text-gray-300 mb-10 max-w-lg mx-auto">
        Проверьте, как вы настроили рабочую среду: от горячих клавиш до DOM и ленты. Вопросы основаны на материалах урока.
      </p>
      <button id="start-btn" class="bg-gradient-to-r from-sky-500 to-indigo-600 hover:from-sky-600 hover:to-indigo-700 text-white font-bold py-4 px-10 rounded-xl text-xl shadow-lg shadow-indigo-500/30 pulse-btn">
        Начать проверку
      </button>
    </div>

    <div id="main-game" class="w-full max-w-4xl mx-auto h-full flex flex-col hide">
      <div class="w-full bg-gray-700/50 rounded-full h-2.5 mb-4 border border-white/10">
        <div id="global-progress-bar" class="bg-sky-500 h-full rounded-full" style="width:0%;transition:width .5s ease-in-out;"></div>
      </div>

      <div id="stats-bar" class="flex flex-wrap justify-between items-center gap-4 bg-black/30 p-3 sm:p-4 rounded-xl mb-4 border border-white/10 fade-in-up">
        <div>
          <span class="text-xs sm:text-sm text-gray-400">Уровень</span>
          <p class="text-base sm:text-xl font-bold text-sky-400" id="level-display"></p>
        </div>
        <div>
          <span class="text-xs sm:text-sm text-gray-400">Капитал</span>
          <p class="text-base sm:text-xl font-bold text-green-400" id="capital-display"></p>
        </div>
        <div>
          <span class="text-xs sm:text-sm text-gray-400">Риск</span>
          <div class="w-20 sm:w-24 bg-gray-700 rounded-full h-2.5">
            <div id="risk-bar" class="bg-red-600 h-2.5 rounded-full" style="width:0%"></div>
          </div>
        </div>
      </div>

      <div id="chart-container" class="flex-grow bg-black/30 p-4 rounded-xl border border-white/10 mb-4 fade-in-up" style="animation-delay:.1s;min-height:250px;">
        <canvas id="equity-chart"></canvas>
      </div>

      <div class="bg-black/30 p-6 rounded-xl border border-white/10 fade-in-up" style="animation-delay:.2s;">
        <p id="scenario-text" class="text-center text-lg md:text-xl font-medium mb-6 min-h-[80px] flex items-center justify-center"></p>
        <div id="answer-buttons" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      </div>
    </div>

    <div id="modal-overlay" class="hide fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
      <div id="level-up-modal" class="hide text-center bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-2xl border-2 border-sky-500 max-w-md mx-4 w-full">
        <h2 class="text-3xl sm:text-4xl font-black text-sky-400 mb-4">УРОВЕНЬ ПРОЙДЕН!</h2>
        <p id="level-up-text" class="text-gray-300 text-base sm:text-lg mb-6 sm:mb-8"></p>
        <button id="next-level-btn" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-6 sm:px-8 rounded-lg text-base sm:text-lg w-full">Продолжить</button>
      </div>
      <div id="game-over-modal" class="hide text-center bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-2xl border-2 border-red-500 max-w-md mx-4 w-full">
        <h2 class="text-3xl sm:text-4xl font-black text-red-500 mb-4">ЛИКВИДАЦИЯ</h2>
        <p class="text-gray-300 text-base sm:text-lg mb-6 sm:mb-8">Капитал исчерпан. Проверьте настройки среды и дисциплину — и попробуйте снова!</p>
        <button id="restart-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 sm:px-8 rounded-lg text-base sm:text-lg w-full">Начать заново</button>
      </div>
      <div id="game-win-modal" class="hide text-center bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-2xl border-2 border-green-500 max-w-md mx-4 w-full">
        <h2 class="text-3xl sm:text-4xl font-black text-green-400 mb-4">УРОК 2 УСВОЕН!</h2>
        <p class="text-gray-300 text-base sm:text-lg mb-6 sm:mb-8">Отличная работа! Ваша техническая среда скальпера выстроена. Готовы к следующему уроку?</p>
        <button id="restart-win-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 sm:px-8 rounded-lg text-base sm:text-lg w-full">Пройти снова</button>
      </div>
    </div>

  </div>

  <script>
    const gameContainer = document.getElementById('game-container');
    const startScreen = document.getElementById('start-screen');
    const mainGame = document.getElementById('main-game');
    const startBtn = document.getElementById('start-btn');
    const answerButtonsContainer = document.getElementById('answer-buttons');
    const levelDisplay = document.getElementById('level-display');
    const capitalDisplay = document.getElementById('capital-display');
    const riskBar = document.getElementById('risk-bar');
    const globalProgressBar = document.getElementById('global-progress-bar');
    const scenarioText = document.getElementById('scenario-text');
    const modalOverlay = document.getElementById('modal-overlay');
    const levelUpModal = document.getElementById('level-up-modal');
    const levelUpText = document.getElementById('level-up-text');
    const nextLevelBtn = document.getElementById('next-level-btn');
    const gameOverModal = document.getElementById('game-over-modal');
    const restartBtn = document.getElementById('restart-btn');
    const gameWinModal = document.getElementById('game-win-modal');
    const restartWinBtn = document.getElementById('restart-win-btn');
    const chartContainer = document.getElementById('chart-container');

    // Те же параметры сложности/капитала
    const levels = [
      { name: "Рабочее место и хоткеи", startCapital: 10000, scenarios: 10, marginCall: 8000,  class: 'level-1-bg', levelUpMsg: "Вы настроили основу: рабочее место, сеть, хоткеи. Дальше — графики и уровни." },
      { name: "Графики и уровни",      startCapital: 15000, scenarios: 10, marginCall: 11000, class: 'level-2-bg', levelUpMsg: "С графиками порядок. В бой — DOM и лента." },
      { name: "DOM и лента принтов",   startCapital: 20000, scenarios: 10, marginCall: 15000, class: 'level-3-bg', levelUpMsg: "Читаете поток ордеров. Теперь — заявки и маршрутизация." },
      { name: "Ордеры, комиссии, риск",startCapital: 30000, scenarios: 10, marginCall: 22000, class: 'level-4-bg', levelUpMsg: "Операционка под контролем. Финал — режим дня и чек-листы." },
      { name: "Режим дня и чек-листы", startCapital: 50000, scenarios: 10, marginCall: 35000, class: 'level-5-bg', levelUpMsg: "ПОБЕДА!" },
    ];

    // 10 сценариев на уровень (структура и балансы как в уроке 1)
    const scenariosByLevel = {
      1: [
        { text: 'Какая сеть предпочтительна для скальпера?', choices: [
          { text: 'Wi-Fi — быстрее и удобнее.', correct: false, impact: -800 },
          { text: 'Проводной Ethernet для стабильной задержки.', correct: true, impact: 900 },
          { text: 'Мобильный интернет, если 5G.', correct: false, impact: -1200 },
          { text: 'Неважно — главное хороший провайдер.', correct: false, impact: -700 },
        ]},
        { text: 'Зачем использовать горячие клавиши (hotkeys)?', choices: [
          { text: 'Чтобы выглядеть профессионально.', correct: false, impact: -300 },
          { text: 'Ускорить ввод/вывод, снизить клики мышью и ошибки.', correct: true, impact: 800 },
          { text: 'Они повышают винрейт.', correct: false, impact: -900 },
          { text: 'Чтобы не пользоваться DOM.', correct: false, impact: -700 },
        ]},
        { text: 'Оптимальная раскладка рабочего места для скальпера:', choices: [
          { text: 'Один ноутбук с тачпадом.', correct: false, impact: -1200 },
          { text: 'Минимум 1 монитор + удобно выведенные DOM/лента/графики.', correct: true, impact: 700 },
          { text: 'Три монитора обязательно, иначе нельзя.', correct: false, impact: -500 },
          { text: 'Монитор вертикально для чатов.', correct: false, impact: -400 },
        ]},
        { text: 'Что делать с уведомлениями/мессенджерами во время сессии?', choices: [
          { text: 'Оставить — вдруг сигнал.', correct: false, impact: -800 },
          { text: 'Выключить/фокус-режим. Внешний шум = ошибки.', correct: true, impact: 700 },
          { text: 'Пусть звук останется, а баннеры отключить.', correct: false, impact: -400 },
          { text: 'Перенести на второй монитор.', correct: false, impact: -500 },
        ]},
        { text: 'Зачем писать видео/скринкаст сессии?', choices: [
          { text: 'Для контента в соцсетях.', correct: false, impact: -400 },
          { text: 'Объективный разбор действий и паттернов ошибок.', correct: true, impact: 900 },
          { text: 'Чтобы ментор проверил сделки в реальном времени.', correct: false, impact: -500 },
          { text: 'Чтобы экономить на дневнике.', correct: false, impact: -700 },
        ]},
        { text: 'Какой режим интерфейса предпочтителен для глаз при долгой работе?', choices: [
          { text: 'Сверхяркий день и белый фон.', correct: false, impact: -500 },
          { text: 'Сбалансированная яркость и тёмная тема.', correct: true, impact: 400 },
          { text: 'Минимальная яркость всегда.', correct: false, impact: -300 },
          { text: 'Автояркость от веб-камеры.', correct: false, impact: -300 },
        ]},
        { text: 'Перед стартом сессии важно проверить…', choices: [
          { text: 'Что музыка включена.', correct: false, impact: -300 },
          { text: 'Подключение к дата-фиду/бирже и синхронизацию времени.', correct: true, impact: 800 },
          { text: 'Пароль от Telegram.', correct: false, impact: -300 },
          { text: 'Гороскоп на день.', correct: false, impact: -1200 },
        ]},
        { text: 'Почему «паник-кнопка» (Flatten/Close All) — обязательна?', choices: [
          { text: 'Чтобы быстро закрыть платформу.', correct: false, impact: -500 },
          { text: 'Аварийно закрыть все позиции при отказе хоткеев/DOM.', correct: true, impact: 900 },
          { text: 'Чтобы быстро перевернуться в шорт.', correct: false, impact: -700 },
          { text: 'Чтобы тестировать торговлю.', correct: false, impact: -400 },
        ]},
        { text: 'Какая мышь лучше для точного скальпинга?', choices: [
          { text: 'Любая, без разницы.', correct: false, impact: -300 },
          { text: 'Надёжная проводная/стойкая к дабл-клику, с колёсом без ускорения.', correct: true, impact: 500 },
          { text: 'Тачпад — быстрее.', correct: false, impact: -1000 },
          { text: 'Трекиболл для скорости.', correct: false, impact: -700 },
        ]},
        { text: 'Зачем сохранять профили/лейауты платформы?', choices: [
          { text: 'Чтобы делиться с друзьями.', correct: false, impact: -300 },
          { text: 'Быстро восстанавливаться после сбоев и переключать пресеты под актив.', correct: true, impact: 700 },
          { text: 'Это формальность.', correct: false, impact: -500 },
          { text: 'Чтобы не делать бэкапы.', correct: false, impact: -400 },
        ]},
      ],
      2: [
        { text: 'Базовый набор таймфреймов для контекста скальпера:', choices: [
          { text: 'Только 1-минутный.', correct: false, impact: -600 },
          { text: 'Старший (15–60m) для контекста + 1–5m для сделок.', correct: true, impact: 900 },
          { text: 'Только тиковый.', correct: false, impact: -700 },
          { text: 'Дневка и неделька — остальное лишнее.', correct: false, impact: -800 },
        ]},
        { text: 'Какие уровни отмечать до открытия?', choices: [
          { text: 'Случайные экстремумы прошлой недели.', correct: false, impact: -400 },
          { text: 'PDH/PDL, премаркет High/Low, уровни объёма, gap-уровни.', correct: true, impact: 1000 },
          { text: 'Линии тренда из чата.', correct: false, impact: -600 },
          { text: 'Только круглые числа.', correct: false, impact: -500 },
        ]},
        { text: 'Роль VWAP/сессионного VWAP для скальпера:', choices: [
          { text: 'Главный сигнал для входа.', correct: false, impact: -500 },
          { text: 'Ориентир баланса дня/контекста; не заменяет план.', correct: true, impact: 700 },
          { text: 'Индикатор «грааль».', correct: false, impact: -1200 },
          { text: 'Не нужен вообще.', correct: false, impact: -500 },
        ]},
        { text: 'Как использовать ATR/ожидаемую волатильность?', choices: [
          { text: 'Не использовать — только мешает.', correct: false, impact: -700 },
          { text: 'Понимать ожидаемый ход, выбирать адекватные цели/стопы.', correct: true, impact: 800 },
          { text: 'Всегда ставить стоп = ATR*3.', correct: false, impact: -500 },
          { text: 'ATR нужен для инвестиций, не для скальпа.', correct: false, impact: -600 },
        ]},
        { text: 'Правильный подход к индикаторам на графике:', choices: [
          { text: 'Чем больше — тем точнее.', correct: false, impact: -900 },
          { text: 'Минимализм: цена/объем/ключевые уровни и ясный план.', correct: true, impact: 800 },
          { text: 'Индикаторы заменяют контекст.', correct: false, impact: -1000 },
          { text: 'Только свечи — остальное запрещено.', correct: false, impact: -400 },
        ]},
        { text: 'Что такое «открывающий диапазон» (OR) и зачем он?', choices: [
          { text: 'Боковик вчерашнего дня.', correct: false, impact: -500 },
          { text: 'Диапазон первых минут/15m — даёт ориентир на утренний импульс.', correct: true, impact: 800 },
          { text: 'Уровень закрытия месяца.', correct: false, impact: -400 },
          { text: 'Ненужное понятие.', correct: false, impact: -600 },
        ]},
        { text: 'Когда лучше избегать входов по графику?', choices: [
          { text: 'Когда рынок стоит в узком диапазоне без объёма.', correct: true, impact: 700 },
          { text: 'Когда есть тренд и объём.', correct: false, impact: -700 },
          { text: 'Когда совпадают уровни разных ТФ.', correct: false, impact: -600 },
          { text: 'Когда пробит ключевой уровень.', correct: false, impact: -600 },
        ]},
        { text: 'Почему важно фиксировать «зоны ликвидности»?', choices: [
          { text: 'Чтобы красиво выглядел график.', correct: false, impact: -300 },
          { text: 'Там вероятны остановки/реакции цены и «борьба» участников.', correct: true, impact: 900 },
          { text: 'Для построения индикаторов.', correct: false, impact: -400 },
          { text: 'Чтобы было больше линий.', correct: false, impact: -400 },
        ]},
        { text: 'Выравнивание контекста между ТФ означает…', choices: [
          { text: 'Игнорировать старший ТФ.', correct: false, impact: -700 },
          { text: 'Входить, когда младший сетап не противоречит старшему сценарию.', correct: true, impact: 900 },
          { text: 'Торговать против тренда старшего ТФ.', correct: false, impact: -900 },
          { text: 'Менять ТФ до совпадения картины.', correct: false, impact: -600 },
        ]},
        { text: 'Что делать с «визуальным шумом» на графике?', choices: [
          { text: 'Добавить больше индикаторов.', correct: false, impact: -800 },
          { text: 'Убрать лишнее: оставьте только то, что влияет на решения.', correct: true, impact: 800 },
          { text: 'Зумить до тиков.', correct: false, impact: -500 },
          { text: 'Ничего — привыкнуть.', correct: false, impact: -400 },
        ]},
      ],
      3: [
        { text: 'DOM (стакан) показывает прежде всего…', choices: [
          { text: 'Прогноз цены от биржи.', correct: false, impact: -900 },
          { text: 'Лимитные заявки покупателей/продавцов по ценовым уровням.', correct: true, impact: 900 },
          { text: 'Только маркет-сделки.', correct: false, impact: -700 },
          { text: 'Тайные уровни маркет-мейкера.', correct: false, impact: -800 },
        ]},
        { text: 'Лента принтов (Time&Sales) нужна для…', choices: [
          { text: 'Истории заявок за неделю.', correct: false, impact: -600 },
          { text: 'Оценки агрессии: кто бьёт по рынку, скорость и размер сделок.', correct: true, impact: 1000 },
          { text: 'Отображения лимитных ордеров.', correct: false, impact: -700 },
          { text: 'Подтверждения индикаторов.', correct: false, impact: -500 },
        ]},
        { text: 'Что такое «абсорбция» в DOM/ленте?', choices: [
          { text: 'Случайное торможение рынка.', correct: false, impact: -600 },
          { text: 'Поглощение рыночного потока крупным лимитным участником.', correct: true, impact: 900 },
          { text: 'Ускорение ленты.', correct: false, impact: -500 },
          { text: 'Ложный объём индикатора.', correct: false, impact: -500 },
        ]},
        { text: 'Как трактовать резкое расширение спреда?', choices: [
          { text: 'Отличный момент входить побольше.', correct: false, impact: -1500 },
          { text: 'Сигнал осторожности: ухудшается исполнение/ликвидность.', correct: true, impact: 900 },
          { text: 'Ничего не значит.', correct: false, impact: -700 },
          { text: 'Гарантия разворота.', correct: false, impact: -800 },
        ]},
        { text: '«Спуфинг» — это…', choices: [
          { text: 'Задержка котировок.', correct: false, impact: -600 },
          { text: 'Выставление крупных лимитных ордеров с намерением быстро снять, вводя в заблуждение.', correct: true, impact: 800 },
          { text: 'Скрытые объёмы (iceberg).', correct: false, impact: -500 },
          { text: 'Название индикатора.', correct: false, impact: -400 },
        ]},
        { text: 'Лучшее применение DOM/ленты для скальпера:', choices: [
          { text: 'Торговать только по ленте без уровней.', correct: false, impact: -900 },
          { text: 'Подтверждать идеи на ключевых уровнях, видеть агрессию/поглощение.', correct: true, impact: 900 },
          { text: 'Подменять торговый план.', correct: false, impact: -800 },
          { text: 'Смотреть только крупные принты.', correct: false, impact: -500 },
        ]},
        { text: 'Market-order против marketable-limit:', choices: [
          { text: 'Это одно и то же.', correct: false, impact: -600 },
          { text: 'Market — исполняется по рынку; marketable-limit — лимит, который сразу пересекает спред.', correct: true, impact: 900 },
          { text: 'Limit всегда быстрее.', correct: false, impact: -700 },
          { text: 'Market безопаснее от проскальзывания.', correct: false, impact: -1000 },
        ]},
        { text: 'Как использовать «айсберг-ордера» (iceberg) в чтении ленты?', choices: [
          { text: 'Не имеют значения.', correct: false, impact: -700 },
          { text: 'Замечать повторяющиеся принты по одной цене при устойчивом удержании уровня.', correct: true, impact: 800 },
          { text: 'Это только на крипте.', correct: false, impact: -600 },
          { text: 'Всегда шортить при айсберге.', correct: false, impact: -900 },
        ]},
        { text: 'Когда избегать агрессивного входа по рынку?', choices: [
          { text: 'Когда спред узкий и ликвидность хорошая.', correct: false, impact: -600 },
          { text: 'При тонкой ликвидности/расширении спреда/новостях.', correct: true, impact: 900 },
          { text: 'Когда тренд ускоряется.', correct: false, impact: -500 },
          { text: 'Всегда избегать.', correct: false, impact: -400 },
        ]},
        { text: 'Правильный выход по DOM/ленте:', choices: [
          { text: 'Держать, пока не вернёт всю прибыль.', correct: false, impact: -1200 },
          { text: 'Снимать у цели/ослабления агрессии/поглощения в обратную сторону.', correct: true, impact: 900 },
          { text: 'Закрывать только по стопу.', correct: false, impact: -700 },
          { text: 'Ждать совет из чата.', correct: false, impact: -800 },
        ]},
      ],
      4: [
        { text: 'Как снизить проскальзывание при входе?', choices: [
          { text: 'Всегда жать Market.', correct: false, impact: -1200 },
          { text: 'По возможности использовать лимит/marketable-limit у цены с ликвидностью.', correct: true, impact: 900 },
          { text: 'Ждать расширения спреда.', correct: false, impact: -800 },
          { text: 'Увеличить размер позиции.', correct: false, impact: -1500 },
        ]},
        { text: 'Комиссии maker/taker для скальпера…', choices: [
          { text: 'Неважны: прибыль всё покроет.', correct: false, impact: -1200 },
          { text: 'Критичны: частые сделки. Предпочитать maker, если позволяет план.', correct: true, impact: 1000 },
          { text: 'Относятся только к крипте.', correct: false, impact: -600 },
          { text: 'Важны лишь на больших депо.', correct: false, impact: -700 },
        ]},
        { text: 'Что делать при частичном исполнении (partial fill)?', choices: [
          { text: 'Игнорировать — само доберётся.', correct: false, impact: -600 },
          { text: 'Иметь хоткей Cancel/Replace/Join bid/ask для добора/выхода.', correct: true, impact: 800 },
          { text: 'Сразу переворачиваться.', correct: false, impact: -900 },
          { text: 'Отменять все заявки всегда.', correct: false, impact: -500 },
        ]},
        { text: 'Стоп-маркет vs стоп-лимит в быстрых движениях:', choices: [
          { text: 'Стоп-лимит гарантирует исполнение.', correct: false, impact: -900 },
          { text: 'Стоп-маркет исполнится почти гарантированно, но с проскальзыванием.', correct: true, impact: 800 },
          { text: 'Разницы нет.', correct: false, impact: -600 },
          { text: 'Стоп-лимит всегда лучше.', correct: false, impact: -700 },
        ]},
        { text: 'Какой фильтр по ликвидности разумен для инструмента скальпа?', choices: [
          { text: 'Любой, лишь бы волатилен.', correct: false, impact: -900 },
          { text: 'Достаточный средний объём/узкий спред/стабильная лента.', correct: true, impact: 900 },
          { text: 'Только дешёвые бумаги.', correct: false, impact: -700 },
          { text: 'Главное — советы чата.', correct: false, impact: -800 },
        ]},
        { text: 'Зачем OCO-брекеты (стоп + цель) по умолчанию?', choices: [
          { text: 'Чтобы было красиво в терминале.', correct: false, impact: -400 },
          { text: 'Автоматизировать выход: один исполняется — второй снимается.', correct: true, impact: 900 },
          { text: 'Для увеличения комиссии.', correct: false, impact: -500 },
          { text: 'Без них нельзя торговать.', correct: false, impact: -400 },
        ]},
        { text: 'Новостной риск для скальпера:', choices: [
          { text: 'Можно игнорировать календарь.', correct: false, impact: -1200 },
          { text: 'Время релизов → возможен спайк/спред/проскальзывание — лучше в стороне.', correct: true, impact: 900 },
          { text: 'Чем больше новостей — тем лучше шанс.', correct: false, impact: -700 },
          { text: 'Относится только к Форексу.', correct: false, impact: -600 },
        ]},
        { text: 'Размер позиции должен…', choices: [
          { text: 'Выбираться «по ощущениям».', correct: false, impact: -1200 },
          { text: 'Следовать плану риска (R на сделку, фикс/процент).', correct: true, impact: 1000 },
          { text: 'Увеличиваться после каждого плюса.', correct: false, impact: -900 },
          { text: 'Зависеть от совета друга.', correct: false, impact: -700 },
        ]},
        { text: 'Какие хоткеи критичны для скальпера?', choices: [
          { text: 'Смайлики в чат.', correct: false, impact: -400 },
          { text: 'Buy/Sell, Join Bid/Ask, Cancel/Replace, Flatten, подтяжка стопа.', correct: true, impact: 900 },
          { text: 'Смена тем оформления.', correct: false, impact: -500 },
          { text: 'Сделать скриншот графика.', correct: false, impact: -300 },
        ]},
        { text: 'Когда НЕ стоит «догонять» цену?', choices: [
          { text: 'Когда рынок тонкий и летит без откатов.', correct: true, impact: 900 },
          { text: 'Когда узкий спред и хороший объём.', correct: false, impact: -600 },
          { text: 'Когда вы заранее поставили алерт.', correct: false, impact: -500 },
          { text: 'Когда старший ТФ согласован.', correct: false, impact: -500 },
        ]},
      ],
      5: [
        { text: 'Утренний ритуал скальпера включает…', choices: [
          { text: 'Чаты и мемы для настроения.', correct: false, impact: -500 },
          { text: 'Календарь новостей, сканер, уровни, сценарии, алерты.', correct: true, impact: 1000 },
          { text: 'Выбор случайного инструмента.', correct: false, impact: -700 },
          { text: 'Тест новой «грааль-стратегии».', correct: false, impact: -800 },
        ]},
        { text: 'Дневной лимит просадки (DD) сработал. Что делать?', choices: [
          { text: 'Снизить размер и «отбиться».', correct: false, impact: -2000 },
          { text: 'Стоп-день. Пауза и разбор — правила важнее эмоций.', correct: true, impact: 1500 },
          { text: 'Искать мега-сетап.', correct: false, impact: -1500 },
          { text: 'Перейти на другой рынок и продолжить.', correct: false, impact: -1200 },
        ]},
        { text: 'Сколько инструментов одновременно оптимально для скальпа?', choices: [
          { text: '10–15, чтобы не упустить.', correct: false, impact: -800 },
          { text: '1–3 «в игре», чтобы не распыляться.', correct: true, impact: 800 },
          { text: 'Только один всегда.', correct: false, impact: -400 },
          { text: 'Сколько выдаст сканер.', correct: false, impact: -500 },
        ]},
        { text: 'Зачем фиксировать статистику сессии?', choices: [
          { text: 'Чтобы похвастаться PnL.', correct: false, impact: -400 },
          { text: 'Видеть реальное ожидание, утечки и работать точечно.', correct: true, impact: 900 },
          { text: 'Для налоговой только.', correct: false, impact: -300 },
          { text: 'Это не нужно при плюсах.', correct: false, impact: -700 },
        ]},
        { text: 'Когда стоит сделать паузу внутри дня?', choices: [
          { text: 'После серии убытков/эйфории — чтобы сбросить тильт.', correct: true, impact: 900 },
          { text: 'Когда рынок идёт по плану.', correct: false, impact: -500 },
          { text: 'Когда нечего делать — не нужна пауза.', correct: false, impact: -600 },
          { text: 'Никогда — время = деньги.', correct: false, impact: -900 },
        ]},
        { text: 'Практика на симуляторе…', choices: [
          { text: 'Бесполезна для скальпа.', correct: false, impact: -800 },
          { text: 'Помогает отработать хоткеи/брекеты/DOM без риска.', correct: true, impact: 800 },
          { text: 'Нужна только новичкам первой недели.', correct: false, impact: -500 },
          { text: 'Заменяет реальную торговлю.', correct: false, impact: -700 },
        ]},
        { text: 'Что делать после достижения дневной цели?', choices: [
          { text: 'Увеличить риск и «пожать ещё».', correct: false, impact: -1200 },
          { text: 'Торговать только по плану; если сетапов нет — остановиться.', correct: true, impact: 900 },
          { text: 'Срочно перейти на другой рынок.', correct: false, impact: -700 },
          { text: 'Открыть случайную сделку на удачу.', correct: false, impact: -1500 },
        ]},
        { text: 'Вечерний разбор включает…', choices: [
          { text: 'Только просмотр PnL.', correct: false, impact: -600 },
          { text: 'Скрины/видео ключевых моментов, тезисы уроков, обновление чек-листов.', correct: true, impact: 1000 },
          { text: 'Удаление убыточных сделок из дневника.', correct: false, impact: -1200 },
          { text: 'Чтение новостей на завтра.', correct: false, impact: -300 },
        ]},
        { text: 'Как бороться с «скольжением внимания» к обилию инструментов?', choices: [
          { text: 'Смотреть всё подряд.', correct: false, impact: -800 },
          { text: 'Фильтровать по «в игре»: объём, направленность, волатильность.', correct: true, impact: 900 },
          { text: 'Добавить больше экранов.', correct: false, impact: -600 },
          { text: 'Следовать сигналам чата.', correct: false, impact: -700 },
        ]},
        { text: 'Финальный принцип урока 2:', choices: [
          { text: 'Среда вторична — важнее удача.', correct: false, impact: -1500 },
          { text: 'Техническая среда = скорость+дисциплина. Решения — через заранее настроенные процессы.', correct: true, impact: 1500 },
          { text: 'DOM и лента заменяют план.', correct: false, impact: -1200 },
          { text: 'Главное — количество сделок.', correct: false, impact: -900 },
        ]},
      ],
    };

    let gameState = {};
    let equityChart;
    let audioSynth;
    let isAudioEnabled = false;

    function initGame(){
      startScreen.classList.remove('hide');
      mainGame.classList.add('hide');
      modalOverlay.classList.add('hide');
      gameState.correctCount = 0;
      gameState.wrongCount = 0;
      gameState.startedAt = Date.now();

      if(!audioSynth && typeof Tone!=='undefined'){
        try{
          audioSynth = {
            correct: new Tone.Synth({oscillator:{type:"triangle"}, envelope:{attack:.005,decay:.1,sustain:.3,release:1}}).toDestination(),
            wrong:   new Tone.Synth({oscillator:{type:"square"},   envelope:{attack:.005,decay:.2,sustain:0, release:.2}}).toDestination(),
            click:   new Tone.MembraneSynth({pitchDecay:.008, octaves:2, envelope:{attack:.001,decay:.2,sustain:0}}).toDestination(),
            levelUp: new Tone.PolySynth(Tone.Synth).toDestination()
          };
          isAudioEnabled = true;
        }catch(e){ isAudioEnabled=false; }
      } else if (typeof Tone==='undefined'){ isAudioEnabled=false; }
    }

    async function startGame(){
      if(isAudioEnabled && Tone.context.state!=='running'){
        try{ await Tone.start(); }catch(e){ isAudioEnabled=false; }
      }
      playSound('click');
      startScreen.classList.add('hide');
      mainGame.classList.remove('hide');
      loadLevel(0);
    }

    function loadLevel(levelIndex){
      const levelData = levels[levelIndex];
      const pool = scenariosByLevel[levelIndex+1];
      gameState = {
        level: levelIndex,
        capital: levelData.startCapital,
        marginCall: levelData.marginCall,
        scenarios: shuffleArray([...pool]).slice(0, levelData.scenarios),
        currentScenario: 0,
        equityData: [levelData.startCapital]
      };
      levelDisplay.textContent = `${levelIndex+1}: ${levelData.name}`;
      updateCapitalDisplay();
      updateGlobalProgress();
      gameContainer.className = `w-full min-h-screen flex flex-col items-center justify-center p-4 transition-all duration-500 ${levelData.class}`;
      setupChart();
      displayScenario();
    }

    function displayScenario(){
      if(gameState.currentScenario >= gameState.scenarios.length){ levelUp(); return; }
      const sc = gameState.scenarios[gameState.currentScenario];
      scenarioText.textContent = sc.text;
      const choices = shuffleArray([...sc.choices]);
      answerButtonsContainer.innerHTML = '';
      choices.forEach(ch=>{
        const b=document.createElement('button');
        b.textContent=ch.text;
        b.className='answer-btn w-full text-left p-4 rounded-lg bg-gray-700/50 hover:bg-gray-600/50 border border-white/20 backdrop-blur-sm';
        b.onclick=()=>selectAnswer(ch);
        answerButtonsContainer.appendChild(b);
      });
    }

    function selectAnswer(choice){
      playSound('click');
      const btns = answerButtonsContainer.querySelectorAll('button');
      btns.forEach(btn=>{
        btn.disabled=true;
        const original = gameState.scenarios[gameState.currentScenario].choices.find(c=>c.text===btn.textContent);
        if(original && original.correct) btn.classList.add('btn-correct');
        else if(btn.textContent===choice.text) btn.classList.add('btn-wrong');
      });

      if(choice.correct) gameState.correctCount=(gameState.correctCount||0)+1;
      else gameState.wrongCount=(gameState.wrongCount||0)+1;

      gameState.capital += choice.impact;
      updateCapitalDisplay();

      if(choice.correct) playSound('correct'); else { playSound('wrong'); gameContainer.classList.add('screen-shake'); setTimeout(()=>gameContainer.classList.remove('screen-shake'),300); }

      if(gameState.capital <= gameState.marginCall){ setTimeout(gameOver,2000); return; }

      gameState.currentScenario++;
      updateGlobalProgress();
      setTimeout(displayScenario,2000);
    }

    function levelUp(){
      const cur = gameState.level;
      if(cur+1 >= levels.length){ gameWin(); return; }
      playSound('levelUp');
      modalOverlay.classList.remove('hide');
      levelUpModal.classList.remove('hide');
      levelUpText.textContent = levels[cur].levelUpMsg;
      gameState.level++;
    }

    function proceedToNextLevel(){
      playSound('click');
      modalOverlay.classList.add('hide');
      levelUpModal.classList.add('hide');
      loadLevel(gameState.level);
    }

    function gameOver(){
      playSound('wrong');
      modalOverlay.classList.remove('hide');
      gameOverModal.classList.remove('hide');
      emitHook('lessonFailed', Object.assign(getGameStats(), {reason:'marginCall'}));
    }

    function gameWin(){
      playSound('levelUp');
      modalOverlay.classList.remove('hide');
      gameWinModal.classList.remove('hide');
      globalProgressBar.style.width='100%';
      emitHook('lessonComplete', getGameStats());
    }

    function restartGame(){ playSound('click'); initGame(); }

    function updateCapitalDisplay(){
      capitalDisplay.textContent = `$${gameState.capital.toLocaleString()}`;
      gameState.equityData.push(gameState.capital);
      updateChart();
      const level = levels[gameState.level];
      const range = level.startCapital - level.marginCall;
      const lost = level.startCapital - gameState.capital;
      const riskPct = Math.max(0, Math.min(100, (lost / range) * 100));
      riskBar.style.width = `${riskPct}%`;
    }

    function updateGlobalProgress(){
      const total = levels.length * levels[0].scenarios;
      const done = gameState.level * levels[0].scenarios + gameState.currentScenario;
      globalProgressBar.style.width = `${(done/total)*100}%`;
    }

    function setupChart(){
      if(typeof Chart==='undefined'){
        chartContainer.innerHTML = `<div class="flex items-center justify-center h-full text-gray-400">График недоступен</div>`;
        return;
      }
      const ctx = document.getElementById('equity-chart').getContext('2d');
      if(equityChart) equityChart.destroy();
      equityChart = new Chart(ctx,{
        type:'line',
        data:{ labels:gameState.equityData.map((_,i)=>i===0?'Start':`S${i}`),
               datasets:[{ label:'Капитал', data:gameState.equityData, borderColor:'#38bdf8', backgroundColor:'rgba(56,189,248,.1)', fill:true, tension:.4, pointRadius:4, pointBackgroundColor:'#38bdf8' }]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}},
                  scales:{ y:{ticks:{color:'rgba(255,255,255,.5)'}, grid:{color:'rgba(255,255,255,.1)'}},
                           x:{ticks:{color:'rgba(255,255,255,.5)'}, grid:{display:false}} } }
      });
    }

    function updateChart(){
      if(!equityChart) return;
      equityChart.data.labels = gameState.equityData.map((_,i)=>i===0?'Start':`S${i}`);
      equityChart.data.datasets[0].data = gameState.equityData;
      equityChart.update();
    }

    function playSound(type){
      if(!isAudioEnabled || !audioSynth) return;
      const now = Tone.now();
      try{
        if(type==='correct') audioSynth.correct.triggerAttackRelease('E5','8n',now);
        else if(type==='wrong') audioSynth.wrong.triggerAttackRelease('C3','8n',now);
        else if(type==='click') audioSynth.click.triggerAttackRelease('C2','8n',now);
        else if(type==='levelUp') audioSynth.levelUp.triggerAttackRelease(['C4','E4','G4','C5'],'8n',now);
      }catch(e){}
    }

    function shuffleArray(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }

    // ---- Hooks / интеграция с кастом-ботом (как в уроке 1) ----
    function getGameStats(){
      const totalLevels = levels.length;
      const totalPlanned = levels.reduce((s,l)=>s+l.scenarios,0);
      const answered = (gameState.level*levels[0].scenarios) + (gameState.currentScenario||0);
      return {
        version:'v1.1.0',
        lesson: 2,
        startedAt: gameState.startedAt||null,
        finishedAt: Date.now(),
        totalLevels,
        currentLevel:(gameState.level||0)+1,
        capital: gameState.capital,
        marginCall: gameState.marginCall,
        correct: gameState.correctCount||0,
        wrong: gameState.wrongCount||0,
        answered,
        totalPlannedScenarios: totalPlanned
      };
    }
    function emitHook(name, detail){
      try{ window.dispatchEvent(new CustomEvent(name,{detail})); }catch(e){}
      try{ if(name==='lessonComplete' && typeof window.onGameComplete==='function'){ window.onGameComplete(detail); } }catch(e){}
    }
    window.gameAPI = { getStats:getGameStats, restart:restartGame, version:'v1.1.0' };

    // DEV panel toggle: Shift+D или даблклик по заголовку
    let __DEV_ENABLED__ = false; const __DEV_BUF__=[];
    function __devLog(evt,data){ const t=new Date().toLocaleTimeString(); __DEV_BUF__.push({t,evt,data}); if(!__DEV_ENABLED__) return;
      const log=document.getElementById('dev-log'); if(!log) return; const row=document.createElement('div'); row.textContent=`[${t}] ${evt}: `+JSON.stringify(data); log.appendChild(row); log.scrollTop=log.scrollHeight; }
    function __ensureDevPanel(){ if(document.getElementById('dev-panel')) return;
      const badge=document.createElement('div'); badge.id='dev-badge'; badge.className='dev-badge'; badge.textContent='DEV'; document.body.appendChild(badge);
      const panel=document.createElement('div'); panel.id='dev-panel'; panel.className='dev-panel'; panel.innerHTML=`
        <h3>DEV / Hook Tester</h3>
        <div class="dev-row">
          <button class="dev-btn" id="dev-ok">Симулировать успех</button>
          <button class="dev-btn" id="dev-fail">Симулировать провал</button>
          <button class="dev-btn" id="dev-clear">Очистить лог</button>
        </div>
        <div id="dev-log" class="dev-log"></div>`;
      document.body.appendChild(panel);
      document.getElementById('dev-ok').onclick = ()=>emitHook('lessonComplete', Object.assign(getGameStats(),{test:true}));
      document.getElementById('dev-fail').onclick = ()=>emitHook('lessonFailed',   Object.assign(getGameStats(),{reason:'manualTest',test:true}));
      document.getElementById('dev-clear').onclick=()=>{const l=document.getElementById('dev-log'); if(l) l.innerHTML='';};
    }
    function __toggleDev(){ __ensureDevPanel(); __DEV_ENABLED__=!__DEV_ENABLED__; const p=document.getElementById('dev-panel'); const b=document.getElementById('dev-badge');
      if(!p||!b) return; p.style.display=__DEV_ENABLED__?'block':'none'; b.style.display=__DEV_ENABLED__?'inline-block':'none';
      if(__DEV_ENABLED__){ const log=document.getElementById('dev-log'); if(log){ log.innerHTML=''; __DEV_BUF__.forEach(x=>{ const d=document.createElement('div'); d.textContent=`[${x.t}] ${x.evt}: `+JSON.stringify(x.data); log.appendChild(d); }); } }
    }
    window.addEventListener('lessonComplete', e=>__devLog('lessonComplete', e.detail));
    window.addEventListener('lessonFailed',   e=>__devLog('lessonFailed',   e.detail));
    (function(){
      const tryBind=()=>{ const t=document.querySelector('#start-screen h1'); if(!t) return false; t.addEventListener('dblclick', __toggleDev); return true; };
      if(!tryBind()){ const obs=new MutationObserver(()=>{ if(tryBind()) obs.disconnect(); }); obs.observe(document.body,{childList:true,subtree:true}); }
      document.addEventListener('keydown', e=>{ if(e.shiftKey && e.key && e.key.toLowerCase()==='d') __toggleDev(); });
    })();

    // UI events
    startBtn.addEventListener('click', startGame);
    nextLevelBtn.addEventListener('click', proceedToNextLevel);
    restartBtn.addEventListener('click', restartGame);
    restartWinBtn.addEventListener('click', restartGame);
    window.onload = initGame;
  </script>
</body>