# SferaTC Telegram Bot

Этот репозиторий содержит исходный код образовательного Telegram-бота для экосистемы SferaTC.

## Быстрый старт

### 1. Клонирование репозитория
```bash
git clone <URL репозитория>
cd SferaTCBot
```

### 2. Установка зависимостей
```bash
pip install -r requirements.txt
```

### 3. Настройка переменных окружения
Скопируйте файл `.env.example` (если он есть) или создайте `.env` вручную и укажите значения ключевых переменных:

- `TELEGRAM_TOKEN` — токен бота из BotFather.
- `ADMIN_CHAT_ID` — ID администратора.
- `OPENROUTER_API_KEY` — ключ доступа к OpenRouter (для функции "Бесплатный ChatGPT").
- `WEBHOOK_URL` — публичный HTTPS-адрес, на который Telegram будет отправлять обновления. Не указывайте протокол `http://`.
- `WEBHOOK_PATH` — (опционально) собственный путь вебхука без слешей по краям. По умолчанию используется безопасный постфикс токена. Укажите пустую строку или `/`, если бот должен принимать запросы по корневому пути.
- `WEBHOOK_PORT` — (опционально) порт, который слушает бот. В средах вроде Render или Railway можно не задавать, порт подхватится из переменной `PORT`.
- `WEBHOOK_LISTEN` — (опционально) адрес, который будет слушать встроенный aiohttp-сервер. По умолчанию `0.0.0.0`.
- `WEBHOOK_SECRET_TOKEN` — (опционально) секрет для заголовка `X-Telegram-Bot-Api-Secret-Token`.
- `WEBHOOK_DROP_PENDING_UPDATES` — (опционально) удалять ли необработанные апдейты при старте вебхука. По умолчанию `true`.

### 4. Запуск бота
```bash
python main.py
```

## Настройка моделей OpenRouter

По умолчанию бот использует бесплатные модели OpenRouter, чтобы исключить ошибки `402 Payment Required`:

- Основная: `deepseek/deepseek-chat-v3.1:free`
- Резервная: `qwen/qwen3-8b:free`

Вы можете переопределить эти значения через переменные окружения `CHATGPT_MODEL_PRIMARY` и `CHATGPT_MODEL_FALLBACK`. Если указать платную модель (без суффикса `:free`), бот автоматически проигнорирует её и оставит только бесплатные варианты, чтобы исключить ошибки `402 Payment Required` при нулевом балансе на OpenRouter.

После изменения моделей перезапустите бота и убедитесь по логам (`bot.log`), что ответы возвращаются успешно и не содержат статуса 402.

## Запуск через Webhook

В продакшене рекомендуется использовать вебхуки. Алгоритм настройки:

1. Укажите `WEBHOOK_URL` и (при необходимости) `WEBHOOK_PATH` в `.env`.
2. На PaaS-платформах (Render, Railway, Fly.io и т. п.) не задавайте `WEBHOOK_PORT` вручную: бот автоматически возьмёт значение из переменной `PORT`, которую выставляет платформа.
3. При необходимости задайте `WEBHOOK_SECRET_TOKEN`, чтобы Telegram отправлял заголовок `X-Telegram-Bot-Api-Secret-Token`. Это позволяет отсекать запросы не от Telegram.
4. Перезапустите процесс бота. В логах должно появиться сообщение вида `Бот @SferaTC_bot запускается через Webhook (listen=0.0.0.0, port=443, path='/your-path')`.

Чтобы временно перейти в режим polling (например, для локальной отладки), просто уберите `WEBHOOK_URL` из `.env`.
